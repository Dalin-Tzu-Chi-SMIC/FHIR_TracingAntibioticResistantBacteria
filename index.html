<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«é™¢æ„ŸæŸ“å‚³æ’­éˆ - å‹•æ…‹å‚³æ’­è·¯å¾‘ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #cy { width: 100%; height: 600px; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
        button { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #cfd8dc; color: #90a4ae; cursor: not-allowed; }
        .legend { margin-top: 10px; font-size: 0.9rem; color: #555; }
        .dot { display: inline-block; width: 10px; height: 10px; margin-right: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦  å‚³æ’­è·¯å¾‘åˆ†æ (Infection Pathway)</h1>
        
        <div class="controls">
            <label>æ ¸å¿ƒç—…äºº IDï¼š</label>
            <input type="text" id="root-id" placeholder="è¼¸å…¥ ID" style="padding: 8px;">
            
            <label>èŒç¨®ï¼š</label>
            <select id="organism" style="padding: 8px;">
                <option value="MRSA">MRSA</option>
                <option value="CRAB">CRAB</option>
                <option value="VRE">VRE</option>
            </select>

            <button id="btn-draw" onclick="runAnalysis()">ğŸš€ åˆ†æå‚³æ’­éˆ</button>
            <span id="status" style="color: #d32f2f; font-weight: bold;"></span>
        </div>

        <div id="cy"></div>
        
        <div class="legend">
            åœ–ä¾‹èªªæ˜ï¼š
            <span class="dot" style="background:#e74c3c; border-radius:50%;"></span><b>åœ“å½¢ (ç´…è‰²)</b>ï¼šç¢ºè¨ºæ„ŸæŸ“è€… &nbsp;&nbsp;
            <span class="dot" style="background:#3498db;"></span><b>æ­£æ–¹å½¢ (è—è‰²)</b>ï¼šæœªæ„ŸæŸ“æ¥è§¸è€… &nbsp;&nbsp;
            <b>å¯¦ç·šç®­é ­</b>ï¼šå‚³æ’­æ–¹å‘ (å…ˆ â†’ å¾Œ) &nbsp;&nbsp;
            <b>è™›ç·š</b>ï¼šå…±åŒæ¥è§¸é—œä¿‚
        </div>
    </div>

    <script>
        let fhirClient = null;

        FHIR.oauth2.ready().then(client => {
            fhirClient = client;
            if(client.patient.id) document.getElementById("root-id").value = client.patient.id;
        }).catch(console.error);

        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgType = document.getElementById("organism").value;
            const btn = document.getElementById("btn-draw");
            const status = document.getElementById("status");

            if (!rootId) { alert("è«‹è¼¸å…¥ ID"); return; }
            btn.disabled = true;
            status.textContent = "ğŸ” æ­£åœ¨é€²è¡Œå…¨ç—…æˆ¿æƒæèˆ‡æ¯”å°...";

            try {
                // 1. æ‰¾å‡ºæ ¸å¿ƒç—…äººçš„ä½é™¢ç—…æˆ¿ (Location)
                const encBundle = await fhirClient.request(`Encounter?subject=${rootId}&_include=Encounter:location`, { flat: false });
                
                let targetLocId = null;
                let targetLocName = "æœªçŸ¥ç—…æˆ¿";

                if(encBundle.entry) {
                    const enc = encBundle.entry.find(e => e.resource.resourceType === "Encounter");
                    if(enc && enc.resource.location) {
                        const locRef = enc.resource.location[0].location?.reference;
                        if(locRef) targetLocId = locRef.split("/").pop();
                        
                        // å˜—è©¦æŠ“å–ç—…æˆ¿åç¨±
                        const locRes = encBundle.entry.find(e => e.resource.resourceType === "Location");
                        if(locRes) targetLocName = locRes.resource.name;
                        else targetLocName = enc.resource.location[0].location?.display || "ç›®æ¨™ç—…æˆ¿";
                    }
                }

                if (!targetLocId) throw new Error("æ‰¾ä¸åˆ°æ­¤ç—…äººçš„ä½é™¢ç—…æˆ¿è³‡è¨Š");
                console.log(`é–å®šç—…æˆ¿: ${targetLocName} (${targetLocId})`);

                // 2. æŠ“å–è©²ç—…æˆ¿æ‰€æœ‰ç›¸é—œäººäº‹ç‰© (Encounter + Patient + Observation)
                const query = `Encounter?location=${targetLocId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=300`;
                const bundle = await fhirClient.request(query, { flat: false });

                // 3. è³‡æ–™è™•ç†
                const patients = {};
                const infectedMap = {}; // è¨˜éŒ„èª°æ„ŸæŸ“äº†ç›®æ¨™èŒç¨® { patientId: date }

                if (bundle.entry) {
                    // å…ˆå»ºç«‹ç—…äººåå†Š
                    bundle.entry.forEach(e => {
                        if (e.resource.resourceType === "Patient") {
                            const p = e.resource;
                            const name = p.name?.[0]?.text || "Unknown";
                            patients[p.id] = { id: p.id, name: name, type: 'contact' }; // é è¨­å¤§å®¶éƒ½æ˜¯æ¥è§¸è€…(æ–¹å½¢)
                        }
                    });

                    // æª¢æŸ¥ Observationï¼Œæ¨™è¨˜æ„ŸæŸ“è€…
                    bundle.entry.forEach(e => {
                        if (e.resource.resourceType === "Observation") {
                            const obs = e.resource;
                            const raw = JSON.stringify(obs).toLowerCase();
                            
                            // åªæœ‰ç¬¦åˆã€Œç›®å‰é¸æ“‡èŒç¨®ã€çš„æ‰ç®—åœ“å½¢
                            if (raw.includes(orgType.toLowerCase())) {
                                const patId = obs.subject?.reference?.split("/").pop();
                                if (patients[patId]) {
                                    patients[patId].type = 'infected'; // å‡ç´šç‚ºæ„ŸæŸ“è€…(åœ“å½¢)
                                    const date = obs.effectiveDateTime ? obs.effectiveDateTime.substring(0, 10) : "9999-99-99";
                                    
                                    // å–æœ€æ—©æª¢é©—æ—¥
                                    if (!infectedMap[patId] || date < infectedMap[patId]) {
                                        infectedMap[patId] = date;
                                        patients[patId].date = date;
                                    }
                                }
                            }
                        }
                    });
                }

                // 4. å»ºç«‹åœ–è¡¨è³‡æ–™
                const nodes = [];
                const edges = [];
                const patList = Object.values(patients);

                if(patList.length === 0) throw new Error("è©²ç—…æˆ¿æŸ¥ç„¡ç—…äººè³‡æ–™");

                // å»ºç«‹ç¯€é»
                patList.forEach(p => {
                    nodes.push({
                        data: {
                            id: p.id,
                            label: `${p.name}\n${p.type === 'infected' ? p.date : 'æ¥è§¸è€…'}`,
                            type: p.type, // 'infected' or 'contact'
                            isRoot: p.id === rootId
                        }
                    });
                });

                // å»ºç«‹é€£ç·š (é‚è¼¯æ ¸å¿ƒï¼)
                for (let i = 0; i < patList.length; i++) {
                    for (let j = i + 1; j < patList.length; j++) {
                        const p1 = patList[i];
                        const p2 = patList[j];

                        // ç‹€æ³ A: å…©è€…éƒ½æ˜¯æ„ŸæŸ“è€… (åœ“å½¢ <-> åœ“å½¢) -> ç•«ç®­é ­
                        if (p1.type === 'infected' && p2.type === 'infected') {
                            // æ¯”è¼ƒæ—¥æœŸï¼Œæ±ºå®šæ–¹å‘
                            if (p1.date < p2.date) {
                                edges.push({ data: { source: p1.id, target: p2.id, type: 'transmit' } });
                            } else if (p2.date < p1.date) {
                                edges.push({ data: { source: p2.id, target: p1.id, type: 'transmit' } });
                            } else {
                                // åŒä¸€å¤©ï¼Œç•«é›™å‘æˆ–ç„¡å‘ (é€™è£¡ç”¨è™›ç·šè¡¨ç¤ºåŒæ™‚ç™¼ç¾)
                                edges.push({ data: { source: p1.id, target: p2.id, type: 'concurrent' } });
                            }
                        }
                        // ç‹€æ³ B: å…¶ä¸­ä¸€äººæ˜¯æ„ŸæŸ“è€…ï¼Œå¦ä¸€äººæ˜¯æ¥è§¸è€… (åœ“å½¢ <-> æ–¹å½¢) -> ç•«è™›ç·š
                        else if (p1.type !== p2.type) {
                             edges.push({ data: { source: p1.id, target: p2.id, type: 'contact' } });
                        }
                        // ç‹€æ³ C: å…©è€…éƒ½æ˜¯æ¥è§¸è€… (æ–¹å½¢ <-> æ–¹å½¢) -> ç•«è™›ç·š (è¦–éœ€æ±‚ï¼Œé€šå¸¸å¯ç•«å¯ä¸ç•«ï¼Œé€™è£¡ç•«å‡ºè¡¨ç¤ºåŒç—…æˆ¿é—œä¿‚)
                        else {
                             edges.push({ data: { source: p1.id, target: p2.id, type: 'contact' } });
                        }
                    }
                }

                status.textContent = `åˆ†æå®Œæˆï¼š${nodes.length} äººï¼Œå…¶ä¸­ ${Object.keys(infectedMap).length} äººæ„ŸæŸ“`;
                renderGraph(nodes, edges);

            } catch (err) {
                console.error(err);
                status.textContent = "éŒ¯èª¤ï¼š" + err.message;
            } finally {
                btn.disabled = false;
            }
        }

        function renderGraph(nodes, edges) {
            cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes: nodes, edges: edges },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)', 'text-wrap': 'wrap', 'text-valign': 'center', 'text-halign': 'center',
                            'font-size': '11px', 'color': '#fff', 'border-width': 2, 'border-color': '#333'
                        }
                    },
                    // æ¨£å¼ï¼šæ„ŸæŸ“è€… (åœ“å½¢)
                    {
                        selector: 'node[type="infected"]',
                        style: { 'shape': 'ellipse', 'background-color': '#e74c3c', 'width': 70, 'height': 70 }
                    },
                    // æ¨£å¼ï¼šæ¥è§¸è€… (æ–¹å½¢)
                    {
                        selector: 'node[type="contact"]',
                        style: { 'shape': 'rectangle', 'background-color': '#3498db', 'width': 60, 'height': 60 }
                    },
                    // æ¨£å¼ï¼šè¢«æŸ¥è©¢çš„ ID (åŠ ç²—é‚Šæ¡†)
                    {
                        selector: 'node[?isRoot]',
                        style: { 'border-width': 4, 'border-color': '#f1c40f' }
                    },
                    // é€£ç·šï¼šå‚³æ’­ (å¯¦ç·šç®­é ­)
                    {
                        selector: 'edge[type="transmit"]',
                        style: { 'width': 3, 'line-color': '#e74c3c', 'target-arrow-color': '#e74c3c', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    // é€£ç·šï¼šæ¥è§¸ (è™›ç·š)
                    {
                        selector: 'edge[type="contact"]',
                        style: { 'width': 2, 'line-color': '#95a5a6', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="concurrent"]',
                        style: { 'width': 3, 'line-color': '#e74c3c', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    }
                ],
                layout: { name: 'cose', animate: true, padding: 50, componentSpacing: 80 }
            });
        }
    </script>
</body>
</html>
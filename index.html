<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ—è—¥èŒåœ°åœ–</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #cy { width: 100%; height: 650px; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
        button { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        button:disabled { background: #cfd8dc; color: #90a4ae; cursor: not-allowed; }
        select, input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; }
        .legend { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 0.9rem; line-height: 1.8; }
        .dot { display: inline-block; width: 12px; height: 12px; margin-right: 5px; vertical-align: middle; border: 1px solid #042433; }
        #status { font-weight: bold; color: #d35400; margin-left: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æŠ—è—¥èŒåœ°åœ– (Multi-Event Analysis)</h1>
        
        <div class="controls">
            <label>ç—…äºº IDï¼š</label>
            <input type="text" id="root-id" placeholder="æ¸¬è©¦ID:670667" style="width: 150px;">
            
            <label>ç›®æ¨™èŒç¨®ï¼š</label>
            <select id="organism">
                <option value="ALL">å…¨éƒ¨ (All)</option>
                <option value="MRSA">Staphylococcus aureus (MRSA)</option>
                <option value="CRAB">Acinetobacter baumannii (CRAB)</option>
                <option value="VRE">Enterococcus faecium (VRE)</option>
                <option value="CRPA">Pseudomonas aeruginosa (CRPA)</option>
                <option value="CRE_COLI">E.coli (CR)</option>
                <option value="CRKP">Klebsiella pneumoniae (CR)</option>
            </select>

            <button id="btn-draw" onclick="runAnalysis()">ğŸš€ é–‹å§‹åˆ†æ</button>
            <span id="status"></span>
        </div>

        <div id="cy"></div>
        
        <div class="legend">
            <b>åœ–ä¾‹èªªæ˜ï¼š</b><br>
            <span class="dot" style="background:#F28B82; border-radius:50%;"></span><b>åœ“å½¢ (ç´…è‰²)</b>ï¼šæ„ŸæŸ“è€… (Infected) - ä¾æª¢é©—æ™‚é–“æ¨™è¨˜ No.1, No.2<br>
            <span class="dot" style="background:#AECBFA;"></span><b>æ­£æ–¹å½¢ (è—è‰²)</b>ï¼šæ¥è§¸è€… (å«åŒç—…æˆ¿ç—…äººã€é†«æŠ€ã€è¡Œæ”¿äººå“¡)<br>
            <b>â¡ å¯¦ç·šç®­é ­</b>ï¼šæ„ŸæŸ“å‚³æ’­ (å…ˆ â†’ å¾Œ)<br>
            <b>--- è™›ç·š</b>ï¼šæ¥è§¸é—œè¯
        </div>
    </div>

    <script>
        let fhirClient = null;
        let cy = null;

        FHIR.oauth2.ready().then(c => { 
            fhirClient = c; 
            if(c.patient.id) document.getElementById("root-id").value = c.patient.id; 
        });

        const BUG_KEYWORDS = {
            "MRSA": ["mrsa", "staphylococcus aureus"],
            "CRAB": ["crab", "acinetobacter", "baumannii"],
            "VRE": ["vre", "enterococcus", "faecium"],
            "CRPA": ["crpa", "pseudomonas", "aeruginosa"],
            "CRE_COLI": ["e.coli", "escherichia", "carbapenem"],
            "CRKP": ["klebsiella", "pneumoniae", "carbapenem"]
        };

        // è‡ªå‹•ç¿»é å·¥å…·
        async function loadAllResources(client, query, maxPages = 10) {
            let allResources = [];
            let pageCount = 0;
            const statusSpan = document.getElementById("status");
            
            // ä¸‹è¼‰ç¬¬ä¸€é 
            let response = await client.request(query, { flat: false });
            if (response.entry) response.entry.forEach(e => allResources.push(e.resource));

            // æª¢æŸ¥ Next Link
            let nextLink = response.link?.find(l => l.relation === "next")?.url;
            while (nextLink && pageCount < maxPages) {
                pageCount++;
                statusSpan.textContent = `ğŸ“¥ ä¸‹è¼‰åˆ†é  ${pageCount + 1}... (ç›®å‰ ${allResources.length} ç­†)`;
                response = await client.request(nextLink, { flat: false });
                if (response.entry) response.entry.forEach(e => allResources.push(e.resource));
                nextLink = response.link?.find(l => l.relation === "next")?.url;
            }
            return allResources;
        }

        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgSelect = document.getElementById("organism").value;
            const btn = document.getElementById("btn-draw");
            const status = document.getElementById("status");

            if (!rootId) { alert("è«‹è¼¸å…¥ç—…äºº ID"); return; }
            btn.disabled = true;
            status.textContent = "ğŸ” 1/3 æœå°‹æ‰€æœ‰æ„ŸæŸ“å²...";

            try {
                // 1. æŠ“å–è©²ç—…äººã€Œæ‰€æœ‰ã€çš„ Observation (ä¸åªæœ€æ–°ä¸€ç­†)
                const obsQuery = `Observation?subject=${rootId}`;
                const obsBundle = await fhirClient.request(obsQuery, { flat: false });
                
                const targetEncIds = new Set(); // æ”¶é›†æ‰€æœ‰æ„ŸæŸ“ç›¸é—œçš„ Encounter ID
                
                if (obsBundle.entry) {
                    obsBundle.entry.forEach(e => {
                        const r = e.resource;
                        const raw = JSON.stringify(r).toLowerCase();
                        
                        // æª¢æŸ¥èŒç¨®
                        let isTarget = false;
                        if (orgSelect === "ALL") isTarget = true;
                        else {
                            const keywords = BUG_KEYWORDS[orgSelect];
                            if (keywords && keywords.every(k => raw.includes(k))) isTarget = true;
                        }

                        if (isTarget && r.encounter?.reference) {
                            // â˜… æ”¶é›†æ‰€æœ‰æ„ŸæŸ“çš„ Encounter ID (å»å‰ç¶´)
                            targetEncIds.add(r.encounter.reference.split("/").pop());
                        }
                    });
                }

                if (targetEncIds.size === 0) throw new Error("æ‰¾ä¸åˆ°è©²ç—…äººçš„ç›®æ¨™èŒç¨®å ±å‘Šï¼Œæˆ–å ±å‘Šæœªé€£çµä½é™¢ç´€éŒ„ã€‚");

                // 2. é‡å°æ¯ä¸€å€‹æ„ŸæŸ“ Encounterï¼Œæ‰¾å‡ºå®ƒçš„ Location
                status.textContent = `ğŸ” 2/3 åˆ†æ ${targetEncIds.size} æ¬¡æ„ŸæŸ“ä½é™¢äº‹ä»¶...`;
                const locationIds = new Set();

                // å¹³è¡ŒæŸ¥è©¢æ‰€æœ‰ Encounter çš„ Location
                const encPromises = Array.from(targetEncIds).map(id => fhirClient.request(`Encounter/${id}`));
                const encounters = await Promise.all(encPromises);

                encounters.forEach(enc => {
                    if (enc.location && enc.location.length > 0) {
                        const locId = enc.location[0].location.reference.split("/").pop();
                        locationIds.add(locId);
                    }
                });

                if (locationIds.size === 0) throw new Error("ç›¸é—œä½é™¢ç´€éŒ„æ²’æœ‰ç™»è¨˜ Location (ç—…æˆ¿)");

                console.log(`âœ… é–å®šç—…æˆ¿æ¸…å–®: ${Array.from(locationIds).join(", ")}`);

                // 3. æƒæã€Œæ‰€æœ‰ç›¸é—œç—…æˆ¿ã€çš„æ¥è§¸è€…
                // é€™æ˜¯ç‚ºäº†åŒæ™‚æŠŠ 7A (èˆŠ) å’Œ 8A (æ–°) çš„äººéƒ½æŠ“å‡ºä¾†
                let allContactResources = [];
                
                for (let locId of locationIds) {
                    status.textContent = `ğŸ” æƒæç—…æˆ¿ ${locId} è³‡æ–™...`;
                    // é‡å°è©²ç—…æˆ¿æŠ“å–æ‰€æœ‰è³‡æ–™ (å«ç¿»é )
                    const query = `Encounter?location=${locId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=200`;
                    const resources = await loadAllResources(fhirClient, query, 10);
                    allContactResources = allContactResources.concat(resources);
                }

                console.log(`ğŸ“¦ è³‡æ–™ä¸‹è¼‰å®Œç•¢: å…± ${allContactResources.length} ç­†`);

                // 4. è§£æè³‡æ–™ (èˆ‡ä¹‹å‰é‚è¼¯ç›¸åŒï¼Œä½†è³‡æ–™æºæ›´å®Œæ•´)
                status.textContent = "ğŸ” 3/3 è¨ˆç®—å‚³æ’­è·¯å¾‘...";
                
                const nodesMap = {};
                const patientEncounters = {};
                
                // åŠ å…¥å·²çŸ¥æ„ŸæŸ“äº‹ä»¶ ID ç¢ºä¿ä¸æ¼
                const infectedEncounters = new Set(targetEncIds);

                // A. å»ºç«‹ç´¢å¼•
                allContactResources.forEach(r => {
                    if (r.resourceType === "Patient") {
                        const name = r.name?.[0]?.text || "Unknown";
                        if(!nodesMap[r.id]) {
                            nodesMap[r.id] = { id: r.id, name: name, type: 'contact', category: 'patient', obsDate: null, rank: null };
                        }
                    }
                    if (r.resourceType === "Encounter") {
                        const patId = r.subject?.reference?.split("/").pop();
                        
                        if (!patientEncounters[patId]) patientEncounters[patId] = [];
                        patientEncounters[patId].push(r); // å­˜å…¥é™£åˆ—

                        // å¦‚æœé€™ç­†æ˜¯å·²çŸ¥çš„æ„ŸæŸ“ä½é™¢ï¼Œå¼·åˆ¶è¨­å®šç‚ºè©²ç—…äººçš„ä¸»è¦ period (æ–¹ä¾¿ç•«åœ–åˆ¤å®š)
                        if (targetEncIds.has(r.id) && nodesMap[patId]) {
                             if(r.period) {
                                nodesMap[patId].period = {
                                    start: new Date(r.period.start).getTime(),
                                    end: r.period.end ? new Date(r.period.end).getTime() : 9999999999999
                                };
                             }
                        }
                    }
                });

                // B. æ¨™è¨˜æ„ŸæŸ“è€… (æƒæä¸‹è¼‰å›ä¾†çš„ Observations)
                allContactResources.forEach(r => {
                    if (r.resourceType === "Observation") {
                        const raw = JSON.stringify(r).toLowerCase();
                        let isTarget = false;
                        if (orgSelect === "ALL") isTarget = true;
                        else {
                            const keywords = BUG_KEYWORDS[orgSelect];
                            if (keywords && keywords.every(k => raw.includes(k))) isTarget = true;
                        }

                        if (isTarget) {
                            const patId = r.subject?.reference?.split("/").pop();
                            const obsEncRef = r.encounter?.reference;
                            
                            if (patId && nodesMap[patId]) {
                                nodesMap[patId].type = 'infected';
                                const d = r.effectiveDateTime ? r.effectiveDateTime.substring(0, 10) : "9999";
                                if (!nodesMap[patId].obsDate || d < nodesMap[patId].obsDate) nodesMap[patId].obsDate = d;
                            }
                            if (obsEncRef) infectedEncounters.add(obsEncRef.split("/").pop());
                        }
                    }
                });

                // C. æ’åº
                const infectedList = Object.values(nodesMap).filter(n => n.type === 'infected')
                    .sort((a, b) => (a.obsDate < b.obsDate ? -1 : 1));
                infectedList.forEach((node, index) => { node.rank = index + 1; });

                // 5. é€£ç·šé‚è¼¯
                const edges = [];
                const activeNodes = new Set();

                // é‡å°ã€Œæ¯ä¸€å€‹ã€æ„ŸæŸ“äº‹ä»¶ï¼Œåˆ†åˆ¥æ‰¾æ¥è§¸è€…
                infectedEncounters.forEach(infEncId => {
                    // æ‰¾å‡ºæ‰€æœ‰äººçš„ Encounter æ˜¯å¦å»åˆæ­¤ ID (æˆ–æ™‚é–“é‡ç–Š)
                    Object.values(patientEncounters).flat().forEach(idxEnc => {
                        
                        // æƒ…å¢ƒ1ï¼šé†«è­·äººå“¡ (ç›´æ¥åƒèˆ‡è©²æ¬¡ä½é™¢)
                        if (idxEnc.id === infEncId) {
                            const p1Id = idxEnc.subject?.reference?.split("/").pop();
                            if(nodesMap[p1Id]) {
                                activeNodes.add(p1Id); // æ ¸å¿ƒç—…äººé¡¯ç¤º

                                if (idxEnc.participant) {
                                    idxEnc.participant.forEach(part => {
                                        if (part.individual && part.individual.reference) {
                                            const rawStaffId = part.individual.reference.split("/").pop();
                                            const staffId = "staff-" + rawStaffId;
                                            const staffName = part.individual.display || "é†«è­·äººå“¡";

                                            if (!nodesMap[staffId]) {
                                                nodesMap[staffId] = { id: staffId, name: staffName, type: 'contact', category: 'staff' };
                                            }
                                            
                                            // ç—…äºº -> é†«è­·
                                            edges.push({ data: { source: p1Id, target: staffId, type: 'contact' } });
                                            activeNodes.add(staffId);
                                        }
                                    });
                                }
                            }
                        }

                        // æƒ…å¢ƒ2ï¼šå®¤å‹ (æ™‚é–“é‡ç–Š)
                        // æˆ‘å€‘éœ€è¦å…ˆæ‰¾åˆ°é€™æ¬¡æ„ŸæŸ“ä½é™¢çš„è©³ç´°è³‡è¨Š (æ™‚é–“)
                        // ä½† patientEncounters æ˜¯æ•£çš„ï¼Œæˆ‘å€‘ç”¨ infEncId å»æ‰¾å®ƒçš„ä¸»äººå’Œæ™‚é–“
                        let sourceEnc = null;
                        for(let pid in patientEncounters) {
                            const found = patientEncounters[pid].find(e => e.id === infEncId);
                            if(found) { sourceEnc = found; break; }
                        }

                        if(sourceEnc && sourceEnc.period) {
                             const p1Id = sourceEnc.subject?.reference?.split("/").pop();
                             const start = new Date(sourceEnc.period.start).getTime();
                             const end = sourceEnc.period.end ? new Date(sourceEnc.period.end).getTime() : 9999999999999;
                             
                             // idxEnc æ˜¯ã€Œå…¶ä»–äººã€çš„ä½é™¢
                             if(idxEnc.id !== infEncId) { 
                                 const p2Id = idxEnc.subject?.reference?.split("/").pop();
                                 if(p1Id !== p2Id && nodesMap[p2Id] && idxEnc.period) {
                                     // æª¢æŸ¥æ˜¯å¦åŒç—…æˆ¿ (å·²ç¶“åœ¨ location è¿´åœˆç¯©éäº†ï¼Œé€™è£¡ä¸»è¦æ˜¯ç¢ºèªæ™‚é–“)
                                     // åš´è¬¹ä¸€é»ï¼šæª¢æŸ¥ idxEnc çš„ Location æ˜¯å¦ç­‰æ–¼ sourceEnc çš„ Location
                                     // ç°¡åŒ–ï¼šå‡è¨­åŒä¸€æ¬¡ä¸‹è¼‰çš„éƒ½æ˜¯åŒç—…æˆ¿
                                     
                                     const oStart = new Date(idxEnc.period.start).getTime();
                                     const oEnd = idxEnc.period.end ? new Date(idxEnc.period.end).getTime() : 9999999999999;
                                     
                                     if (start <= oEnd && end >= oStart) {
                                         // ç•«ç·š
                                         if (nodesMap[p2Id].type === 'infected') {
                                             const d1 = nodesMap[p1Id].obsDate || "9999";
                                             const d2 = nodesMap[p2Id].obsDate || "9999";
                                             if (d1 < d2) edges.push({ data: { source: p1Id, target: p2Id, type: 'transmit' } });
                                             else if (d2 < d1) edges.push({ data: { source: p2Id, target: p1Id, type: 'transmit' } });
                                             else edges.push({ data: { source: p1Id, target: p2Id, type: 'concurrent' } });
                                         } else {
                                             edges.push({ data: { source: p1Id, target: p2Id, type: 'contact' } });
                                         }
                                         activeNodes.add(p1Id);
                                         activeNodes.add(p2Id);
                                     }
                                 }
                             }
                        }
                    });
                });

                // 6. å»é‡èˆ‡ç¹ªåœ–
                const uniqueEdges = [];
                const edgeSet = new Set();
                edges.forEach(e => {
                    const key = `${e.data.source}-${e.data.target}-${e.data.type}`;
                    if(!edgeSet.has(key)) {
                        edgeSet.add(key);
                        uniqueEdges.push(e);
                    }
                });

                const finalNodes = Object.values(nodesMap)
                    .filter(n => activeNodes.has(n.id))
                    .map(n => {
                        let labelText = n.name;
                        if (n.type === 'infected') labelText = `No.${n.rank} ${n.name}\n${n.obsDate}`;
                        return {
                            data: {
                                id: n.id, label: labelText, type: n.type, isRoot: n.id === rootId
                            }
                        };
                    });

                status.textContent = `é¡¯ç¤ºï¼š${finalNodes.length} å€‹ç¯€é»`;
                renderGraph(finalNodes, uniqueEdges);

            } catch (err) {
                console.error(err);
                status.textContent = "éŒ¯èª¤: " + err.message;
            } finally {
                btn.disabled = false;
            }
        }

        function renderGraph(nodes, edges) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes, edges },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)', 'text-wrap': 'wrap', 'text-valign': 'center', 'text-halign': 'center',
                            'font-size': '12px', 'font-weight': 'bold', 'color': '#000000',
                            'border-width': 2, 'border-color': '#042433'
                        }
                    },
                    {
                        selector: 'node[type="infected"]',
                        style: { 'shape': 'ellipse', 'background-color': '#F28B82', 'width': 90, 'height': 90 }
                    },
                    {
                        selector: 'node[type="contact"]',
                        style: { 'shape': 'rectangle', 'background-color': '#AECBFA', 'width': 80, 'height': 80 }
                    },
                    {
                        selector: 'node[?isRoot]',
                        style: { 'border-width': 5, 'border-color': '#f1c40f' }
                    },
                    {
                        selector: 'edge[type="transmit"]',
                        style: { 'width': 4, 'line-color': '#F28B82', 'target-arrow-color': '#F28B82', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="contact"]',
                        style: { 'width': 2, 'line-color': '#95a5a6', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="concurrent"]',
                        style: { 'width': 4, 'line-color': '#F28B82', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    { selector: '.highlight', style: { 'border-width': 4, 'border-color': '#000', 'z-index': 999 } },
                    { selector: '.faded', style: { 'opacity': 0.1 } }
                ],
                layout: { name: 'cose', animate: true, padding: 50, componentSpacing: 80 }
            });

            cy.on('tap', function(e) {
                if(e.target === cy){
                    cy.elements().removeClass('faded highlight');
                } else {
                    const node = e.target;
                    cy.elements().addClass('faded');
                    const neighborhood = node.neighborhood().add(node);
                    neighborhood.removeClass('faded').addClass('highlight');
                }
            });
        }
    </script>
</body>
</html>
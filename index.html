<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>ç–«èª¿å‚³æ’­éˆ (ç²¾æº–å¤šæ®µå¼æŸ¥è©¢ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
      body { font-family: "Microsoft JhengHei", sans-serif; background: #f0f2f5; padding: 20px; }
      .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      h1 { color: #2c3e50; margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
      .controls { background: #e8f4fd; padding: 20px; border-radius: 6px; margin-bottom: 20px; border-left: 5px solid #1a73e8; }
      .step { margin-bottom: 10px; font-size: 0.95rem; color: #555; }
      #cy { width: 100%; height: 600px; border: 1px solid #ccc; border-radius: 4px; background: #fff; }
      button { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; }
      button:hover { background: #1557b0; }
      button:disabled { background: #ccc; cursor: not-allowed; }
      #status { font-weight: bold; color: #d93025; display: block; margin-top: 10px; }
      #debug { background: #222; color: #0f0; padding: 10px; height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 20px; border-radius: 4px; }
      .badge { display: inline-block; padding: 2px 6px; border-radius: 4px; background: #ddd; font-size: 0.8em; margin-right: 5px; }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¥ é™¢å…§æ„ŸæŸ“ç²¾æº–ç–«èª¿ (Location-Based)</h1>
      
      <div class="controls">
        <div class="step">
          <b>æŸ¥è©¢é‚è¼¯ï¼š</b> é–å®šç—…äºº ID â” æ‰¾å‡ºä½é™¢ç—…æˆ¿ ID â” æŠ“å–è©²ç—…æˆ¿æ‰€æœ‰æ¥è§¸è€… â” ç¯©é¸æŠ—è—¥èŒ
        </div>
        <div style="margin-top: 15px;">
          <label><b>Step 1.</b> æ ¸å¿ƒç—…äºº IDï¼š</label>
          <input type="text" id="root-id" placeholder="ä¾‹å¦‚: 669814" style="padding: 8px; width: 150px; font-size: 1rem;">
          
          <label style="margin-left: 15px;"><b>Step 2.</b> èŒç¨®ï¼š</label>
          <select id="organism" style="padding: 8px; font-size: 1rem;">
            <option value="MRSA">MRSA</option>
            <option value="CRAB">CRAB</option>
            <option value="VRE">VRE</option>
            <option value="ALL">å…¨éƒ¨é¡¯ç¤º</option>
          </select>

          <button id="btn-draw" style="margin-left: 15px;">ğŸš€ é–‹å§‹ç²¾æº–æŸ¥è©¢</button>
        </div>
        <span id="status"></span>
      </div>

      <div id="cy"></div>
      <div id="debug">ç³»çµ±æº–å‚™å°±ç·’...</div>
    </div>

    <script>
      function log(msg) {
        const d = document.getElementById("debug");
        d.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        d.scrollTop = d.scrollHeight;
      }

      async function run() {
        const btn = document.getElementById("btn-draw");
        const status = document.getElementById("status");
        const rootId = document.getElementById("root-id").value.trim();
        const orgType = document.getElementById("organism").value;

        if (!rootId) { alert("è«‹å…ˆè¼¸å…¥ç—…äºº ID"); return; }

        // é‡ç½®ç‹€æ…‹
        btn.disabled = true;
        document.getElementById("status").textContent = "";
        document.getElementById("debug").innerHTML = ""; // æ¸…ç©º Log
        
        try {
            const client = await FHIR.oauth2.ready();
            
            // --- ç¬¬ä¸€æ®µï¼šæŸ¥è©²ç—…äººæ˜¯å¦å­˜åœ¨ ---
            status.textContent = "ğŸ” éšæ®µ 1/3: ç¢ºèªç—…äººèˆ‡ä½é™¢ç´€éŒ„...";
            log(`æ­£åœ¨æŸ¥è©¢ Patient/${rootId}...`);
            
            // åŒæ™‚æŠ“ Patient èˆ‡ä»–çš„ Encounter
            const patientData = await client.request(`Patient/${rootId}`);
            log(`âœ… æ‰¾åˆ°ç—…äºº: ${patientData.name?.[0]?.text}`);

            const encounterBundle = await client.request(`Encounter?subject=${rootId}&_include=Encounter:location`, { flat: false });
            
            if (!encounterBundle.entry || encounterBundle.entry.length === 0) {
                throw new Error("æ­¤ç—…äººæ²’æœ‰ä»»ä½• Encounter (ä½é™¢) ç´€éŒ„ï¼Œç„¡æ³•è¿½è¹¤ç—…æˆ¿ã€‚");
            }

            // --- ç¬¬äºŒæ®µï¼šæ‰¾å‡ºä»–ä½éçš„ç—…æˆ¿ (Location ID) ---
            const targetLocations = new Set();
            const locationMap = {}; // ID -> Name

            encounterBundle.entry.forEach(e => {
                const res = e.resource;
                if (res.resourceType === "Location") {
                    locationMap[res.id] = res.name;
                }
                if (res.resourceType === "Encounter" && res.location) {
                    res.location.forEach(locWrapper => {
                        const ref = locWrapper.location?.reference;
                        if (ref) {
                            const locId = ref.split("/").pop();
                            targetLocations.add(locId);
                            // å¦‚æœ bundle æ²’å¸¶å› location resourceï¼Œè©¦è‘—ç”¨ display
                            if (!locationMap[locId] && locWrapper.location.display) {
                                locationMap[locId] = locWrapper.location.display;
                            }
                        }
                    });
                }
            });

            if (targetLocations.size === 0) {
                throw new Error("æ­¤ç—…äººçš„ä½é™¢ç´€éŒ„ä¸­æ²’æœ‰ Location (ç—…æˆ¿) è³‡è¨Šï¼Œç„¡æ³•è¿½è¹¤ã€‚");
            }

            const locIds = Array.from(targetLocations);
            log(`âœ… é–å®šç—…æˆ¿ ID: ${locIds.join(", ")}`);
            locIds.forEach(id => log(`   ğŸ“ ç—…æˆ¿åç¨±: ${locationMap[id] || "æœªçŸ¥"}`));

            // --- ç¬¬ä¸‰æ®µï¼šç²¾æº–æ’ˆå–é€™äº›ç—…æˆ¿çš„æ‰€æœ‰äºº ---
            status.textContent = `ğŸ” éšæ®µ 2/3: æ­£åœ¨æƒæ ${locIds.length} å€‹ç—…æˆ¿å…§çš„æ‰€æœ‰æ¥è§¸è€…...`;
            
            // é€™è£¡ä½¿ç”¨ _revinclude å’Œ _include çš„çµ„åˆæŠ€
            // Encounter?location=... 
            // &_include=Encounter:subject (é †ä¾¿æŠŠç—…äººå€‹è³‡æŠ“å›ä¾†)
            // &_revinclude=Observation:encounter (é †ä¾¿æŠŠæª¢é©—å ±å‘ŠæŠ“å›ä¾†)
            
            const promises = locIds.map(locId => {
                const query = `Encounter?location=${locId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=200`;
                log(`   ğŸ‘‰ ç™¼é€æŸ¥è©¢: ${query}`);
                return client.request(query, { flat: false });
            });

            const results = await Promise.all(promises);
            
            // --- è³‡æ–™å½™æ•´ ---
            status.textContent = "ğŸ” éšæ®µ 3/3: åˆ†æå‚³æ’­è·¯å¾‘èˆ‡ç¹ªåœ–...";
            
            const allResources = [];
            const processedIds = new Set();

            results.forEach(bundle => {
                if(bundle.entry) {
                    bundle.entry.forEach(e => {
                        if(!processedIds.has(e.resource.id)) {
                            processedIds.add(e.resource.id);
                            allResources.push(e.resource);
                        }
                    });
                }
            });

            log(`ğŸ“¦ å…±å–å¾— ${allResources.length} ç­†ç›¸é—œè³‡æ–™ (åŒ…å«å®¤å‹ã€æª¢é©—å ±å‘Š)`);

            // å»ºç«‹å¿«é€Ÿç´¢å¼•
            const patIndex = {};
            const obsList = [];
            
            allResources.forEach(r => {
                if(r.resourceType === "Patient") patIndex[r.id] = r;
                if(r.resourceType === "Observation") obsList.push(r);
            });

            // --- å»ºç«‹åœ–è¡¨ç¯€é» ---
            const nodes = new Map();
            const links = [];

            obsList.forEach(obs => {
                // 1. ç¯©é¸èŒç¨®
                const raw = JSON.stringify(obs).toLowerCase();
                if (orgType !== "ALL" && !raw.includes(orgType.toLowerCase())) return;

                // 2. å–å¾—ç—…äººè³‡è¨Š
                const patRef = obs.subject?.reference || "";
                const patId = patRef.split("/").pop();
                const patient = patIndex[patId];
                if (!patient) return; // æœ‰ Observation ä½†æ²’æŠ“åˆ° Patient Resource (ç½•è¦‹)

                const name = patient.name?.[0]?.text || "Unknown";
                
                // 3. å–å¾—æ—¥æœŸèˆ‡åœ°é» (å¾ Observation æˆ–é—œè¯çš„ Encounter æ¨ç®—)
                // å› ç‚ºæˆ‘å€‘æ˜¯ç”¨ Location æŸ¥å›ä¾†çš„ï¼Œæ‰€ä»¥é€™è£¡ä¸€å®šæ˜¯åœ¨ç›®æ¨™ç—…æˆ¿å…§
                const date = obs.effectiveDateTime ? obs.effectiveDateTime.substring(0, 10) : "ç„¡æ—¥æœŸ";
                
                // é€™è£¡ç°¡åŒ–ï¼šæ—¢ç„¶æ˜¯ç”¨ LocID æŸ¥å›ä¾†çš„ï¼Œæˆ‘å€‘å°±ç›´æ¥æ¨™ç¤ºè©² LocID å°æ‡‰çš„åç¨±
                // è‹¥è¦æ›´ç²¾æº–ï¼Œæ‡‰è©²æ¯”å° Observation -> Encounter -> Location
                const encRef = obs.encounter?.reference || "";
                const encId = encRef.split("/").pop();
                // é€™è£¡åšå€‹ç°¡å–®åˆ¤æ–·ï¼Œå¦‚æœé€™å€‹ Observation å±¬æ–¼æˆ‘å€‘æŸ¥å›ä¾†çš„ Encounter ä¹‹ä¸€
                
                // ç‚ºäº† Demo æ–¹ä¾¿ï¼Œæˆ‘å€‘å…ˆå‡è¨­åªè¦åœ¨é€™æ‰¹è³‡æ–™è£¡ï¼Œå°±æ˜¯ç›¸é—œçš„
                // å¯¦éš›é¡¯ç¤ºç—…æˆ¿åç¨±
                let displayWard = "éš”é›¢ç—…æˆ¿"; 
                // å˜—è©¦æ‰¾å›é€™æ˜¯å“ªå€‹ Location
                // (çœç•¥è¤‡é›œåæŸ¥ï¼Œç›´æ¥ç”¨æˆ‘å€‘é–å®šçš„ LocationMap)
                const matchedLocId = locIds.find(lid => JSON.stringify(allResources).includes(lid)); 
                if(matchedLocId) displayWard = locationMap[matchedLocId] || "ç›®æ¨™ç—…æˆ¿";

                nodes.set(patId, { id: patId, name, ward: displayWard, date, organism: orgType });
                
                if(patId === rootId) {
                    log(`ğŸ¯ æ ¸å¿ƒç—…äººè³‡æ–™ç¢ºèª: ${date} / ${displayWard}`);
                }
            });

            if(nodes.size === 0) {
                status.textContent = "âŒ æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„æŠ—è—¥èŒæ¡ˆä¾‹ (å¯èƒ½è©²ç—…æˆ¿ç„¡äººæ„ŸæŸ“æˆ–èŒç¨®ä¸ç¬¦)";
                btn.disabled = false;
                return;
            }

            log(`ç¯©é¸å¾Œå…± ${nodes.size} ä½ç—…äºº`);

            // --- å»ºç«‹é€£ç·š (åªè¦æ˜¯åŒä¸€å¤©ã€åŒä¸€ç—…æˆ¿) ---
            const nodeList = Array.from(nodes.values());
            for(let i=0; i<nodeList.length; i++) {
                for(let j=i+1; j<nodeList.length; j++) {
                    const a = nodeList[i];
                    const b = nodeList[j];
                    
                    // é€™è£¡åˆ¤å®šéå¸¸å¯¬é¬†ï¼šå› ç‚ºæˆ‘å€‘å·²ç¶“æ˜¯ç”¨ Location å» Query äº†
                    // æ‰€ä»¥åªè¦æ—¥æœŸä¸€æ¨£ï¼Œä»–å€‘å°±ä¸€å®šæ˜¯å®¤å‹
                    if(a.date === b.date) {
                        links.push({ source: a.id, target: b.id });
                    }
                }
            }

            status.textContent = `ç¹ªè£½å®Œæˆï¼š${nodes.size} äºº, ${links.length} æ¢é€£çµ`;
            renderCy(Array.from(nodes.values()), links, rootId);

        } catch (err) {
            console.error(err);
            log("âŒ éŒ¯èª¤: " + err.message);
            status.textContent = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹çœ‹ Log";
        } finally {
            btn.disabled = false;
        }
      }

      function renderCy(nodes, links, rootId) {
          const elements = [];
          nodes.forEach(n => {
              elements.push({
                  data: {
                      id: n.id,
                      label: `${n.name}\n${n.date}`,
                      color: n.id === rootId ? "#d93025" : "#1a73e8" // Root ç´…è‰²ï¼Œå…¶ä»–è—è‰²
                  }
              });
          });
          links.forEach((l, i) => {
              elements.push({ data: { id: 'e'+i, source: l.source, target: l.target } });
          });

          cytoscape({
              container: document.getElementById('cy'),
              elements: elements,
              style: [
                  { selector: 'node', style: { 
                      'background-color': 'data(color)', 
                      'label': 'data(label)', 
                      'color': '#333', 
                      'text-wrap': 'wrap', 
                      'text-valign': 'center',
                      'font-size': '11px',
                      'width': 60, 'height': 60 
                  }},
                  { selector: 'edge', style: { 'width': 3, 'line-color': '#ccc' } }
              ],
              layout: { name: 'cose', animate: false, padding: 50 }
          });
      }

      document.getElementById("btn-draw").addEventListener("click", run);
    </script>
  </body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>疫調傳播鏈 SMART App (FHIR Sandbox)</title>

    <!-- SMART on FHIR JS 客戶端 -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

    <!-- Cytoscape.js：用來畫關係圖 -->
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei",
          sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f7;
      }

      header {
        background: #003366;
        color: #fff;
        padding: 1rem 1.5rem;
      }

      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      header small {
        display: block;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      main {
        padding: 1rem 1.5rem 2rem 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
      }

      .card h2 {
        margin-top: 0;
        font-size: 1.1rem;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 0.3rem;
        margin-bottom: 0.5rem;
      }

      .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem 2rem;
        font-size: 0.9rem;
      }

      .meta-label {
        font-weight: 600;
      }

      #cy {
        width: 100%;
        height: 500px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      .stats {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 0.5rem;
      }

      button {
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        border: none;
        background: #003366;
        color: #fff;
        cursor: pointer;
        font-size: 0.85rem;
      }

      button:hover {
        background: #004a99;
      }

      button:disabled {
        background: #9e9e9e;
        cursor: not-allowed;
      }

      select,
      input[type="text"] {
        padding: 0.25rem 0.4rem;
        border-radius: 999px;
        border: 1px solid #ccc;
        font-size: 0.85rem;
      }

      .error {
        color: #b00020;
        font-weight: 600;
      }

      pre {
        background: #111827;
        color: #e5e7eb;
        padding: 0.7rem;
        border-radius: 6px;
        font-size: 0.8rem;
        overflow: auto;
        max-height: 260px;
      }

      @media (max-width: 768px) {
        main {
          padding: 0.8rem;
        }
        #cy {
          height: 420px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>疫調傳播鏈 SMART App</h1>
      <small>從 FHIR(Observation / Encounter) 組出傳播鏈關係圖</small>
    </header>

    <main>
      <!-- FHIR 連線資訊 -->
      <section class="card">
        <h2>FHIR 連線資訊</h2>
        <div id="meta-content" class="meta-row">
          <span>初始化中...</span>
        </div>
      </section>

      <!-- 傳播鏈圖 -->
      <section class="card">
        <h2>傳播鏈關係圖（病人 ↔ 共同接觸點）</h2>

        <div class="stats" id="graph-stats">尚未載入 FHIR 資料</div>

        <div
          style="
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
          "
        >
          <label for="patient-id-input" style="font-size: 0.85rem;">指定 Patient ID：</label>
          <input
            type="text"
            id="patient-id-input"
            placeholder="例如：130206（留空則使用 SMART context 病人）"
            style="min-width: 180px;"
          />

          <label for="sel-organism" style="font-size: 0.85rem;">選擇抗藥菌株：</label>
          <select id="sel-organism">
            <option value="ALL">全部菌種（不過濾）</option>
            <option value="CRAB">Acinetobacter baumannii(CRAB)</option>
            <option value="E_COLI_CR">E.coli (CR)</option>
            <option value="VRE">Enterococcus faecium(VRE)</option>
            <option value="KP_CR">Klebsiella pneumoniae (CR)</option>
            <option value="CRPA">Pseudomonas aeruginosa(CRPA)</option>
            <option value="MRSA">Staphylococcus aureus(MRSA)</option>
          </select>

          <button id="btn-reload-graph">重新從 FHIR 重建傳播鏈圖</button>
        </div>
        <div style="font-size: 0.8rem; color: #555; margin-bottom: 0.5rem;">
          邏輯：以指定的 Patient ID，從 FHIR 抓取該病人的抗藥菌 Observation
         （laboratory），依「菌種 + Encounter 地點 + 日期」產生接觸點，將共用接觸點的病人連成鏈。
        </div>

        <div id="cy"></div>
      </section>

      <!-- 除錯 / JSON -->
      <section class="card">
        <h2>除錯訊息 / 原始 JSON</h2>
        <button id="btn-clear-debug">清除訊息</button>
        <pre id="debug-log">// 這裡會顯示 client 狀態、錯誤訊息與部分原始 JSON</pre>
      </section>
    </main>

    <script>
      /********** 抗藥菌株選項設定 **********/
      const BACTERIA_OPTIONS = [
        {
          id: "ALL",
          label: "全部菌種（不過濾）",
          keywords: []
        },
        {
          id: "CRAB",
          label: "Acinetobacter baumannii(CRAB)",
          keywords: ["acinetobacter", "baumannii", "crab"]
        },
        {
          id: "E_COLI_CR",
          label: "E.coli (CR)",
          keywords: ["e.coli", "escherichia coli", "cr e.coli"]
        },
        {
          id: "VRE",
          label: "Enterococcus faecium(VRE)",
          keywords: ["enterococcus faecium", "vre"]
        },
        {
          id: "KP_CR",
          label: "Klebsiella pneumoniae (CR)",
          keywords: ["klebsiella pneumoniae", "cr kp", "cr klebsiella"]
        },
        {
          id: "CRPA",
          label: "Pseudomonas aeruginosa(CRPA)",
          keywords: ["pseudomonas aeruginosa", "crpa"]
        },
        {
          id: "MRSA",
          label: "Staphylococcus aureus(MRSA)",
          keywords: ["staphylococcus aureus", "mrsa"]
        }
      ];

      function getSelectedBacteriaOption() {
        const sel = document.getElementById("sel-organism");
        const val = sel.value || "ALL";
        return BACTERIA_OPTIONS.find((x) => x.id === val) || BACTERIA_OPTIONS[0];
      }

      /********** 小工具：Debug Log **********/
      function logDebug(obj, title) {
        const pre = document.getElementById("debug-log");
        const now = new Date().toISOString();
        let text = pre.textContent || "";
        text += `\n\n[${now}] ${title || "訊息"}\n`;
        try {
          text += typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
        } catch {
          text += String(obj);
        }
        pre.textContent = text;
      }

      /********** 小工具：Mask 病人名稱 / ID **********/
      function maskName(name) {
        if (!name) return "";
        const s = name.trim();
        if (s.length === 1) return s + "○";
        if (s.length === 2) return s[0] + "○";
        return s[0] + "○" + s.slice(2);
      }

      function shortId(id) {
        if (!id) return "";
        const s = String(id);
        if (s.length <= 4) return s;
        return s.slice(0, 2) + "…" + s.slice(-2);
      }

      /********** 判斷：Observation 是否為抗藥菌 / 感染相關 **********
       * 放寬條件：只要 code.text / display / valueString 裡面有 MRSA/VRE/CRAB/CRPA 等字樣，就算。
       **************************************************************/
      function isAntibioticRelatedObservation(obs) {
        if (!obs || !obs.code) return false;

        const code = obs.code;
        const text = (code.text || "").toLowerCase();
        const codings = code.coding || [];
        const codingStr = codings
          .map((c) => `${c.system || ""}|${c.code || ""}|${c.display || ""}`.toLowerCase())
          .join(" ");

        const valueString = (obs.valueString || "").toLowerCase();
        const valueConceptText =
          (obs.valueCodeableConcept && obs.valueCodeableConcept.text) ?
          obs.valueCodeableConcept.text.toLowerCase() :
          "";

        const haystack = `${text} ${codingStr} ${valueString} ${valueConceptText}`;

        // 主要抗藥菌關鍵字（專門給你這次 MDRO 傳播鍊用）
        const mdroKeywords = [
          "mrsa",
          "vre",
          "acinetobacter",
          "baumannii",
          "crab",
          "pseudomonas",
          "crpa",
          "klebsiella",
          "e.coli",
          "escherichia coli",
          "carbapenem",
          " resistant",
          "多重抗藥",
          "mdro"
        ];

        if (mdroKeywords.some((k) => haystack.includes(k))) {
          return true;
        }

        // 補充：interpretation 有 R 或 Resistant 也算
        const interpCodes = (obs.interpretation || []).flatMap((i) =>
          (i.coding || []).map((c) => (c.code || "").toUpperCase())
        );
        if (interpCodes.includes("R")) return true;

        const interpText = (obs.interpretation || [])
          .map((i) => (i.text || "").toLowerCase())
          .join(" ");
        if (interpText.includes("resistan")) return true;

        return false;
      }

      /********** 判斷：Observation 是否符合下拉選到的菌種 **********/
      function isObservationMatchBacteria(obs, organismText, bacteriaOption) {
        if (!bacteriaOption || bacteriaOption.id === "ALL") return true;
        const hay =
          `${organismText || ""} ${(obs.valueString || "")}`.toLowerCase();
        if (!hay) return false;
        return bacteriaOption.keywords.some((k) => hay.includes(k));
      }

      /********** 畫 FHIR 連線資訊 **********/
      function renderMeta(client) {
        const div = document.getElementById("meta-content");
        const st = client.state || {};
        const url = st.serverUrl || "(未知)";
        const token = st.tokenResponse || {};
        const patientId = st.patientId || (client.patient && client.patient.id);

        div.innerHTML = `
          <div>
            <span class="meta-label">FHIR Server：</span>
            <span>${url}</span>
          </div>
          <div>
            <span class="meta-label">Access Token：</span>
            <span>${token.access_token ? "已取得" : "尚未取得 / 不需 token"}</span>
          </div>
          <div>
            <span class="meta-label">Patient Id (context)：</span>
            <span>${patientId || "(無病人 context 或為 system/user app)"}</span>
          </div>
          <div>
            <span class="meta-label">Scope：</span>
            <span>${st.tokenResponse?.scope || "(未知)"}</span>
          </div>
        `;
      }

      /********** 從 FHIR 建立傳播鏈所需的資料結構（單一病人版本） **********/
      async function buildTransmissionData(client, bacteriaOption, patientId) {
        if (!patientId) {
          throw new Error("沒有 Patient ID，無法查詢 Observation。");
        }

        // 只抓這個病人的實驗室 Observation，並把 Encounter + Location 一起 include 回來
        const url =
          "Observation?_include=Observation:encounter" +
          "&_include:iterate=Encounter:location" +
          "&category=laboratory" +
          `&subject=Patient/${encodeURIComponent(patientId)}`;

        const bundle = await client.request(url, { flat: false });
        logDebug(bundle, "Observation Bundle（單一病人，laboratory）");

        const entries = bundle.entry || [];
        const patientsById = {};
        const encountersById = {};
        const locationsById = {};
        const observations = [];

        // 收集 Observation / Patient / Encounter / Location
        for (const e of entries) {
          const res = e.resource;
          if (!res || !res.resourceType) continue;
          switch (res.resourceType) {
            case "Observation":
              observations.push(res);
              break;
            case "Patient":
              patientsById[res.id] = res;
              break;
            case "Encounter":
              encountersById[res.id] = res;
              break;
            case "Location":
              locationsById[res.id] = res;
              break;
          }
        }

        // 若 bundle 裡沒有 Patient 資源，補抓一次
        if (!patientsById[patientId]) {
          try {
            const p = await client.request(`Patient/${patientId}`);
            patientsById[p.id] = p;
            logDebug(p, "補抓 Patient");
          } catch (err) {
            logDebug(err, "補抓 Patient 失敗");
          }
        }

        const cases = [];

        for (const obs of observations) {
          // 先判斷是不是抗藥菌觀察
          if (!isAntibioticRelatedObservation(obs)) {
            continue;
          }

          const subjRef = obs.subject && obs.subject.reference;
          if (!subjRef || !subjRef.startsWith("Patient/")) continue;
          const pId = subjRef.split("/")[1];

          const patientRes = patientsById[pId];

          // Encounter + Location/病房
          let wardName = "";
          let enc = null;

          const encRef = obs.encounter && obs.encounter.reference;
          if (encRef && encRef.startsWith("Encounter/")) {
            const encId = encRef.split("/")[1];
            enc = encountersById[encId] || null;
          }

          if (enc) {
            // 先看 Encounter.location.display → 再看 serviceProvider
            if (enc.location && enc.location.length > 0) {
              const locRef = enc.location[0].location && enc.location[0].location.reference;
              const locDisplay =
                (enc.location[0].location && enc.location[0].location.display) || "";
              if (locDisplay) wardName = locDisplay;
              if (!wardName && locRef && locRef.startsWith("Location/")) {
                const locId = locRef.split("/")[1];
                const locRes = locationsById[locId];
                if (locRes && locRes.name) wardName = locRes.name;
              }
            }
            if (!wardName && enc.serviceProvider && enc.serviceProvider.display) {
              wardName = enc.serviceProvider.display;
            }
          }

          // 菌名：從 Observation.code 的 text / display / code 組一個字串
          const code = obs.code || {};
          const coding0 = (code.coding && code.coding[0]) || {};
          const organismTextSource =
            (code.text || "") +
            " " +
            (coding0.display || "") +
            " " +
            (coding0.code || "");
          const organism =
            code.text || coding0.display || coding0.code || "未標註菌名";

          // 再用下拉選到的菌種做一次篩選
          if (!isObservationMatchBacteria(obs, organismTextSource, bacteriaOption)) {
            continue;
          }

          // 檢驗時間
          const effective =
            obs.effectiveDateTime ||
            (obs.effectivePeriod && obs.effectivePeriod.start) ||
            obs.issued ||
            "";
          const dateKey = effective ? String(effective).slice(0, 10) : "未知日期";
          const locKey = wardName || "未知地點";

          cases.push({
            obsId: obs.id,
            patientId: pId,
            patientRes,
            encounter: enc,
            wardName: locKey,
            organism,
            dateKey
          });
        }

        logDebug(
          {
            patientId,
            caseCount: cases.length,
            patientCount: Object.keys(patientsById).length,
            bacteria: bacteriaOption.label
          },
          "初步病例 Case 數統計（依菌株過濾後）"
        );

        return { cases, patientsById };
      }

      /********** 從 cases 組出「病人節點 + 接觸點節點 + 邊」 **********/
      function buildGraphElementsFromCases(cases, patientsById) {
        const patientNodeMap = {};
        const contactNodeMap = {};
        const pcEdges = [];
        const ppEdgeSet = new Set();
        const contactToPatients = {};

        for (const c of cases) {
          const pId = c.patientId;

          // 病人節點
          if (!patientNodeMap[pId]) {
            const p = patientsById[pId];
            let displayName = "";

            if (p && p.name && p.name[0]) {
              const n = p.name[0];
              const full =
                n.text ||
                `${n.family || ""}${(n.given || []).join("")}`.trim();
              displayName = full || "";
            }

            const masked =
              maskName(displayName) || shortId(pId) || "未知病人";
            patientNodeMap[pId] = {
              id: "p-" + pId,
              label: masked
            };
          }

          // 接觸點 = 病房 + 菌名 + 日期
          const contactKey = `${c.wardName}|${c.organism}|${c.dateKey}`;
          if (!contactNodeMap[contactKey]) {
            const nodeId =
              "c-" +
              btoa(unescape(encodeURIComponent(contactKey))).replace(/=/g, "");
            const label = `${c.wardName}\n${c.organism}\n${c.dateKey}`;
            contactNodeMap[contactKey] = {
              id: nodeId,
              label
            };
          }

          pcEdges.push({
            patientId: pId,
            contactKey
          });

          if (!contactToPatients[contactKey]) {
            contactToPatients[contactKey] = new Set();
          }
          contactToPatients[contactKey].add(pId);
        }

        // P-P 邊：共享接觸點的病人兩兩相連
        const ppEdges = [];
        for (const [contactKey, set] of Object.entries(contactToPatients)) {
          const arr = Array.from(set);
          for (let i = 0; i < arr.length; i++) {
            for (let j = i + 1; j < arr.length; j++) {
              const a = arr[i];
              const b = arr[j];
              if (a === b) continue;
              const pid1 = a < b ? a : b;
              const pid2 = a < b ? b : a;
              const key = pid1 + "|" + pid2;
              if (ppEdgeSet.has(key)) continue;
              ppEdgeSet.add(key);
              ppEdges.push({
                from: "p-" + pid1,
                to: "p-" + pid2
              });
            }
          }
        }

        const elements = [];

        // 病人節點
        Object.values(patientNodeMap).forEach((p) => {
          elements.push({
            data: {
              id: p.id,
              label: p.label,
              type: "patient"
            }
          });
        });

        // 接觸點節點
        Object.values(contactNodeMap).forEach((c) => {
          elements.push({
            data: {
              id: c.id,
              label: c.label,
              type: "contact"
            }
          });
        });

        // P-C 邊
        pcEdges.forEach((e, idx) => {
          const pNode = patientNodeMap[e.patientId];
          const cNode = contactNodeMap[e.contactKey];
          if (!pNode || !cNode) return;
          elements.push({
            data: {
              id: "pc-" + idx,
              source: pNode.id,
              target: cNode.id,
              type: "pc"
            }
          });
        });

        // P-P 邊
        ppEdges.forEach((e, idx) => {
          elements.push({
            data: {
              id: "pp-" + idx,
              source: e.from,
              target: e.to,
              type: "pp"
            }
          });
        });

        return {
          elements,
          patientCount: Object.keys(patientNodeMap).length,
          contactCount: Object.keys(contactNodeMap).length,
          pcCount: pcEdges.length,
          ppCount: ppEdges.length
        };
      }

      /********** 用 Cytoscape 畫圖 **********/
      function renderGraph(elements, statsText) {
        const statsDiv = document.getElementById("graph-stats");
        statsDiv.textContent = statsText;

        const cy = cytoscape({
          container: document.getElementById("cy"),
          elements: elements,
          style: [
            {
              selector: "node[type = 'patient']",
              style: {
                "background-color": "#f28b82",
                "border-color": "#042433",
                "border-width": 2,
                label: "data(label)",
                "text-valign": "center",
                "text-halign": "center",
                "text-wrap": "wrap",
                "font-size": 10,
                shape: "ellipse",
                width: 40,
                height: 40
              }
            },
            {
              selector: "node[type = 'contact']",
              style: {
                "background-color": "#aecbfa",
                "border-color": "#042433",
                "border-width": 1,
                label: "data(label)",
                "text-valign": "center",
                "text-halign": "center",
                "text-wrap": "wrap",
                "font-size": 9,
                shape: "round-rectangle",
                padding: "4px"
              }
            },
            {
              selector: "edge[type = 'pc']",
              style: {
                "line-style": "solid",
                "line-color": "#7a7a7a",
                "target-arrow-shape": "none",
                width: 1
              }
            },
            {
              selector: "edge[type = 'pp']",
              style: {
                "line-style": "solid",
                "line-color": "#7a7a7a",
                "target-arrow-shape": "triangle",
                "target-arrow-color": "#7a7a7a",
                "curve-style": "straight",
                width: 2
              }
            },
            {
              selector: ":selected",
              style: {
                "border-width": 3,
                "border-color": "#ffab00",
                "line-color": "#ffab00",
                "target-arrow-color": "#ffab00"
              }
            },
            {
              selector: ".dim",
              style: {
                opacity: 0.2
              }
            }
          ],
          layout: {
            name: "cose",
            animate: false
          }
        });

        // 點病人節點時 highlight 相關
        cy.on("tap", "node[type = 'patient']", (evt) => {
          const node = evt.target;
          cy.elements().removeClass("dim");
          const neighborhood = node.closedNeighborhood();
          cy.elements().difference(neighborhood).addClass("dim");
        });

        // 點空白還原
        cy.on("tap", (evt) => {
          if (evt.target === cy) {
            cy.elements().removeClass("dim");
          }
        });
      }

      /********** 初始化整個 App **********/
      FHIR.oauth2
        .ready()
        .then(async (client) => {
          logDebug(client.state, "SMART client.state");
          renderMeta(client);

          const reloadBtn = document.getElementById("btn-reload-graph");
          const clearBtn = document.getElementById("btn-clear-debug");
          const selOrganism = document.getElementById("sel-organism");
          const patientInput = document.getElementById("patient-id-input");

          // 如果 SMART context 有病人，就預填在 input
          const state = client.state || {};
          const ctxPatientId =
            state.patientId || (client.patient && client.patient.id);
          if (ctxPatientId) {
            patientInput.placeholder =
              `例如：${ctxPatientId}（留空則使用這個病人）`;
          }

          async function reloadGraph() {
            const opt = getSelectedBacteriaOption();

            const manualPid = (patientInput.value || "").trim();
            const effectivePid = manualPid || ctxPatientId;

            if (!effectivePid) {
              document.getElementById("graph-stats").innerHTML =
                '<span class="error">沒有 Patient ID，請輸入病人 ID 或透過 launch.html 帶入病人。</span>';
              renderGraph([], "尚未指定病人，無法建立傳播鏈。");
              return;
            }

            reloadBtn.disabled = true;
            document.getElementById("graph-stats").textContent =
              `從 FHIR 讀取資料並重建傳播鏈中...（Patient/${effectivePid}，菌種：${opt.label}）`;

            try {
              const { cases, patientsById } = await buildTransmissionData(
                client,
                opt,
                effectivePid
              );

              if (!cases.length) {
                renderGraph(
                  [],
                  `查無符合條件的抗藥菌 Observation（Patient/${effectivePid}，菌種：${opt.label}），無法建立傳播鏈。`
                );
                reloadBtn.disabled = false;
                return;
              }

              const {
                elements,
                patientCount,
                contactCount,
                pcCount,
                ppCount
              } = buildGraphElementsFromCases(cases, patientsById);

              const statsText = `節點：病人 ${patientCount} 人、接觸點 ${contactCount} 個；邊：病人-接觸點 ${pcCount} 條、病人-病人 ${ppCount} 條。（Patient/${effectivePid}，菌種：${opt.label}）`;
              renderGraph(elements, statsText);
            } catch (err) {
              console.error(err);
              logDebug(err, "建立傳播鏈失敗");
              document.getElementById("graph-stats").innerHTML =
                '<span class="error">無法從 FHIR 建立傳播鏈，請查看下方 Debug 訊息。</span>';
              renderGraph([], "建立傳播鏈失敗。");
            } finally {
              reloadBtn.disabled = false;
            }
          }

          // 初次載入
          await reloadGraph();

          // 綁定事件
          reloadBtn.addEventListener("click", reloadGraph);
          clearBtn.addEventListener("click", () => {
            document.getElementById("debug-log").textContent =
              "// 已清除訊息，可重新操作。";
          });
          selOrganism.addEventListener("change", reloadGraph);
        })
        .catch((err) => {
          console.error("SMART 初始化失敗", err);
          logDebug(err, "SMART 初始化失敗");
          document.getElementById("meta-content").innerHTML =
            '<span class="error">SMART 初始化失敗，請確認 launch.html 設定與沙盒環境。</span>';
          document.getElementById("graph-stats").textContent =
            "無法載入 FHIR 資料。";
        });
    </script>
  </body>
</html>

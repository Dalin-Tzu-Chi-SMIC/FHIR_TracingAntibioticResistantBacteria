<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>ç–«èª¿å‚³æ’­éˆ SMART App (FHIR Sandbox)</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
      body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei", sans-serif; margin: 0; padding: 0; background: #f5f5f7; }
      header { background: #003366; color: #fff; padding: 1rem 1.5rem; }
      header h1 { margin: 0; font-size: 1.4rem; }
      main { padding: 1rem 1.5rem; max-width: 1200px; margin: 0 auto; }
      .card { background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.08); padding: 1rem; margin-bottom: 1rem; }
      #cy { width: 100%; height: 600px; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
      button { padding: 0.5rem 1rem; border-radius: 4px; border: none; background: #003366; color: white; cursor: pointer; }
      button:disabled { background: #ccc; }
      input, select { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
      .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; background: #eee; }
    </style>
  </head>
  <body>
    <header>
      <h1>ç–«èª¿å‚³æ’­éˆ</h1>
      <small>è‡ªå‹•æ··åˆæŸ¥è©¢ï¼šç¢ºä¿å­¤ç«‹ç¯€é»ä¹Ÿèƒ½é¡¯ç¤º</small>
    </header>

    <main>
      <section class="card">
        <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <label>é¸æ“‡èŒç¨®ï¼š</label>
          <select id="sel-organism">
            <option value="ALL">å…¨éƒ¨èŒç¨®</option>
            <option value="MRSA" selected>MRSA (Staphylococcus aureus)</option>
            <option value="CRAB">CRAB (Acinetobacter baumannii)</option>
            <option value="VRE">VRE (Enterococcus faecium)</option>
          </select>

          <label>ç—…äºº IDï¼š</label>
          <input type="text" id="txt-root-patient" placeholder="ä¾‹å¦‚: 669799" style="width: 120px;">
          
          <button id="btn-search">ğŸ” æŸ¥è©¢å‚³æ’­éˆ</button>
          <button id="btn-clear" style="background:#666;">æ¸…é™¤</button>
        </div>
        <div id="status-msg" style="margin-top: 10px; color: #d32f2f; font-weight: bold;"></div>
      </section>

      <section class="card">
        <div id="cy"></div>
      </section>

      <section class="card">
        <h3>Debug Log</h3>
        <pre id="debug-log" style="background:#111; color:#0f0; padding:10px; height:200px; overflow:auto;"></pre>
      </section>
    </main>

    <script>
      // 1. å·¥å…·å‡½å¼
      function log(msg) {
        const d = document.getElementById("debug-log");
        d.textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
        d.scrollTop = d.scrollHeight;
        console.log(msg);
      }

      function maskName(name) {
        if (!name) return "æœªçŸ¥";
        return name.length > 2 ? name[0] + "â—‹" + name.slice(2) : name[0] + "â—‹";
      }

      // 2. æ ¸å¿ƒé‚è¼¯
      async function drawGraph(client) {
        const btn = document.getElementById("btn-search");
        const status = document.getElementById("status-msg");
        const rootId = document.getElementById("txt-root-patient").value.trim();
        const organismType = document.getElementById("sel-organism").value;
        
        btn.disabled = true;
        status.textContent = "æ­£åœ¨å‘ FHIR Server æŸ¥è©¢è³‡æ–™ï¼Œè«‹ç¨å€™...";
        log("é–‹å§‹æŸ¥è©¢...");
        
        try {
            // --- æ­¥é©Ÿ A: æ··åˆæŸ¥è©¢ç­–ç•¥ ---
            // ç­–ç•¥ï¼šä¸ç®¡ä½¿ç”¨è€…æœ‰æ²’æœ‰è¼¸å…¥ IDï¼Œæˆ‘å€‘éƒ½æŸ¥æœ€è¿‘ 100 ç­† (æ‰¾ç¾¤èš)ã€‚
            // å¦‚æœæœ‰è¼¸å…¥ IDï¼Œé¡å¤–å†æŸ¥è©²ç—…äººçš„è³‡æ–™ï¼Œç¢ºä¿ä»–ä¸€å®šæœƒå‡ºç¾ (å³ä½¿ä»–æ˜¯å­¤é»)ã€‚
            
            const promises = [];
            
            // Query 1: å…¨åŸŸæœ€è¿‘ 100 ç­† (æŠ“èƒŒæ™¯å€¼)
            const qGlobal = "Observation?category=laboratory&_count=100" +
                            "&_include=Observation:subject" +
                            "&_include=Observation:encounter" +
                            "&_include:iterate=Encounter:location";
            promises.push(client.request(qGlobal, { flat: false }));

            // Query 2: æŒ‡å®šç—…äºº (å¦‚æœæœ‰è¼¸å…¥)
            if (rootId) {
                log(`é¡å¤–é–å®šæŸ¥è©¢ç—…äºº: ${rootId}`);
                const qRoot = `Observation?category=laboratory&subject=Patient/${rootId}` +
                              "&_include=Observation:subject" +
                              "&_include=Observation:encounter" +
                              "&_include:iterate=Encounter:location";
                promises.push(client.request(qRoot, { flat: false }));
            }

            const results = await Promise.all(promises);
            
            // --- æ­¥é©Ÿ B: åˆä½µèˆ‡å»é‡ ---
            const allResources = [];
            const seenIds = new Set();
            
            results.forEach(bundle => {
                if(bundle.entry) {
                    bundle.entry.forEach(e => {
                        if(e.resource && !seenIds.has(e.resource.id)) {
                            seenIds.add(e.resource.id);
                            allResources.push(e.resource);
                        }
                    });
                }
            });

            log(`å…±å–å¾— ${allResources.length} å€‹ Resources`);

            // --- æ­¥é©Ÿ C: è§£æè³‡æ–™ ---
            const patients = {};
            const encounters = {};
            const locations = {};
            const obsList = [];

            allResources.forEach(r => {
                if(r.resourceType === "Patient") patients[r.id] = r;
                if(r.resourceType === "Encounter") encounters[r.id] = r;
                if(r.resourceType === "Location") locations[r.id] = r;
                if(r.resourceType === "Observation") obsList.push(r);
            });

            // --- æ­¥é©Ÿ D: å»ºç«‹æ¡ˆä¾‹ (Cases) ---
            const nodes = new Map(); // patientId -> NodeInfo
            const links = [];

            // é—œéµå­—éæ¿¾å™¨
            const keywords = {
                "MRSA": ["mrsa", "staphylococcus", "aureus"],
                "CRAB": ["crab", "acinetobacter", "baumannii"],
                "VRE": ["vre", "enterococcus"],
                "ALL": []
            };
            const currentKeywords = keywords[organismType];

            for(const obs of obsList) {
                // 1. æª¢æŸ¥æ˜¯å¦ç‚ºæŠ—è—¥èŒ
                const rawCode = JSON.stringify(obs.code || {}).toLowerCase();
                const rawValue = (obs.valueString || "").toLowerCase();
                const fullText = rawCode + " " + rawValue;

                // å…ˆæª¢æŸ¥æ˜¯å¦ç¬¦åˆ MDRO å¤§é¡
                const isMDRO = ["mrsa","vre","crab","acinetobacter","baumannii","pseudomonas","klebsiella","e.coli","resistant"].some(k => fullText.includes(k));
                if(!isMDRO) continue;

                // å†æª¢æŸ¥æ˜¯å¦ç¬¦åˆä¸‹æ‹‰é¸å–®
                if(organismType !== "ALL") {
                    const match = currentKeywords.some(k => fullText.includes(k));
                    if(!match) continue;
                }

                // 2. è§£æç—…äºº
                const patRef = obs.subject?.reference || "";
                const patId = patRef.includes('/') ? patRef.split('/').pop() : patRef;
                if(!patients[patId]) continue; // æ²’æŠ“åˆ°ç—…äººæª”å°±ä¸è™•ç†

                // 3. è§£æç—…æˆ¿èˆ‡æ—¥æœŸ (é—œéµï¼)
                const dateKey = obs.effectiveDateTime ? obs.effectiveDateTime.substring(0, 10) : "ç„¡æ—¥æœŸ";
                
                let wardName = "æœªçŸ¥ç—…æˆ¿";
                const encRef = obs.encounter?.reference || "";
                const encId = encRef.includes('/') ? encRef.split('/').pop() : encRef;
                
                if(encId && encounters[encId]) {
                    const enc = encounters[encId];
                    // å˜—è©¦å¾ Location Resource æŠ“
                    if(enc.location && enc.location.length > 0) {
                         const locRef = enc.location[0].location?.reference;
                         const locDisplay = enc.location[0].location?.display; // å‚™ç”¨
                         
                         if(locRef) {
                             const locId = locRef.includes('/') ? locRef.split('/').pop() : locRef;
                             if(locations[locId]) {
                                 wardName = locations[locId].name;
                             }
                         }
                         // å¦‚æœ Resource æ²’æŠ“åˆ°ï¼Œç”¨ display è£œæ•‘
                         if(wardName === "æœªçŸ¥ç—…æˆ¿" && locDisplay) {
                             wardName = locDisplay;
                         }
                    }
                }

                // å„²å­˜ç¯€é»è³‡è¨Š
                const pName = maskName(patients[patId].name?.[0]?.text || "Unknown");
                nodes.set(patId, { id: patId, name: pName, ward: wardName, date: dateKey, organism: organismType });
                
                log(`æ‰¾åˆ°æ¡ˆä¾‹: ID=${patId}, ç—…æˆ¿=${wardName}, æ—¥æœŸ=${dateKey}`);
            }

            // --- æ­¥é©Ÿ E: å»ºç«‹é€£ç·š (Edges) ---
            // é‚è¼¯: åŒç—…æˆ¿ + åŒæ—¥æœŸ = æœ‰é€£ç·š
            const nodeList = Array.from(nodes.values());
            
            for(let i=0; i<nodeList.length; i++) {
                for(let j=i+1; j<nodeList.length; j++) {
                    const a = nodeList[i];
                    const b = nodeList[j];
                    
                    // å¯¬é¬†åˆ¤å®šï¼šåªè¦ç—…æˆ¿åç¨±ä¸€æ¨£ (ä¸”ä¸æ˜¯æœªçŸ¥)ï¼Œä¸”æ—¥æœŸä¸€æ¨£
                    if(a.ward !== "æœªçŸ¥ç—…æˆ¿" && a.ward === b.ward && a.date === b.date) {
                        links.push({ source: a.id, target: b.id });
                        log(`å»ºç«‹é€£ç·š: ${a.id} <--> ${b.id}`);
                    }
                }
            }

            // --- æ­¥é©Ÿ F: ç¹ªåœ– ---
            const elements = [];
            
            // 1. å¦‚æœæœ‰æŒ‡å®š Root IDï¼Œä¸”ä»–ä¸åœ¨çµæœä¸­ï¼Œé¡¯ç¤ºéŒ¯èª¤
            if(rootId && !nodes.has(rootId)) {
                status.textContent = `æŸ¥ç„¡ç—…äºº ${rootId} çš„æŠ—è—¥èŒè³‡æ–™ (å¯èƒ½æ˜¯æ—¥æœŸå¤ªä¹…é æˆ–ç¯©é¸æ¢ä»¶ä¸ç¬¦)`;
            } else {
                status.textContent = `æŸ¥è©¢å®Œæˆã€‚æ‰¾åˆ° ${nodes.size} ä½ç—…äººï¼Œ${links.length} æ¢é€£ç·šã€‚`;
            }

            // 2. åŠ å…¥ç¯€é»
            nodes.forEach(n => {
                const isRoot = (n.id === rootId);
                elements.push({
                    data: { 
                        id: n.id, 
                        label: `${n.name}\n${n.ward}\n${n.date}`,
                        color: isRoot ? "#d93025" : "#4285f4" // Root ç‚ºç´…è‰²ï¼Œå…¶ä»–äººè—è‰²
                    }
                });
            });

            // 3. åŠ å…¥é€£ç·š
            links.forEach((l, idx) => {
                elements.push({ data: { id: 'e'+idx, source: l.source, target: l.target } });
            });

            if(elements.length === 0) {
                status.textContent = "æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è³‡æ–™ã€‚";
            }

            cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'background-color': 'data(color)',
                            'label': 'data(label)',
                            'color': '#333',
                            'font-size': '10px',
                            'text-wrap': 'wrap',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'width': '60px',
                            'height': '60px'
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#ccc',
                            'target-arrow-color': '#ccc',
                            'target-arrow-shape': 'triangle'
                        }
                    }
                ],
                layout: { name: 'cose', animate: false }
            });

        } catch (err) {
            console.error(err);
            log("éŒ¯èª¤: " + err.message);
            status.textContent = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹ Debug Log";
        } finally {
            btn.disabled = false;
        }
      }

      // 3. åˆå§‹åŒ– SMART Client
      FHIR.oauth2.ready().then(client => {
          log("FHIR Client åˆå§‹åŒ–æˆåŠŸ");
          log("Server: " + client.state.serverUrl);
          
          if(client.patient.id) {
              document.getElementById("txt-root-patient").value = client.patient.id;
          }

          document.getElementById("btn-search").addEventListener("click", () => drawGraph(client));
          document.getElementById("btn-clear").addEventListener("click", () => {
              document.getElementById("txt-root-patient").value = "";
              drawGraph(client); // æ¸…é™¤å¾ŒæŸ¥å…¨åŸŸ
          });

          // è‡ªå‹•åŸ·è¡Œä¸€æ¬¡
          // drawGraph(client); 
      }).catch(console.error);
    </script>
  </body>
</html>
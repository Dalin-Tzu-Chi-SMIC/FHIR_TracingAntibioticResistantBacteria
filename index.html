<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>å‚³æ’­éˆåˆ†æ (é‚è¼¯ä¿®æ­£ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        #cy { width: 100%; height: 600px; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
        button { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        .legend { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="container">
        <h2>ğŸ¦  å‚³æ’­è·¯å¾‘åˆ†æ (åš´æ ¼é€£ç·šç‰ˆ)</h2>
        <div class="controls">
            <label>æ ¸å¿ƒç—…äºº IDï¼š</label>
            <input type="text" id="root-id" placeholder="è¼¸å…¥ ID" style="padding: 8px;">
            <label>èŒç¨®ï¼š</label>
            <select id="organism" style="padding: 8px;">
                <option value="MRSA">MRSA</option>
                <option value="CRAB">CRAB</option>
            </select>
            <button id="btn-draw" onclick="runAnalysis()">ğŸš€ åˆ†æå‚³æ’­éˆ</button>
            <span id="status" style="color: #d32f2f; font-weight: bold; margin-left: 10px;"></span>
        </div>
        <div id="cy"></div>
        <div class="legend">
            åœ–ä¾‹ï¼š
            <span style="color:#e74c3c">â— ç´…åœ“</span> = æ„ŸæŸ“è€… &nbsp;|&nbsp; 
            <span style="color:#3498db">â–  è—æ–¹</span> = æ¥è§¸è€… &nbsp;|&nbsp; 
            <span>â¡ å¯¦ç·šç®­é ­</span> = å‚³æ’­æ–¹å‘ &nbsp;|&nbsp; 
            <span style="color:#999">--- è™›ç·š</span> = æ¥è§¸é—œä¿‚ (åƒ…é™æ„ŸæŸ“è€…é€£å‡º)
        </div>
    </div>

    <script>
        let fhirClient = null;
        FHIR.oauth2.ready().then(c => { fhirClient = c; if(c.patient.id) document.getElementById("root-id").value = c.patient.id; });

        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgType = document.getElementById("organism").value;
            const btn = document.getElementById("btn-draw");
            const status = document.getElementById("status");

            if (!rootId) { alert("è«‹è¼¸å…¥ ID"); return; }
            btn.disabled = true;
            status.textContent = "ğŸ” æƒæä¸­...";

            try {
                // 1. æ‰¾ç—…æˆ¿
                const encData = await fhirClient.request(`Encounter?subject=${rootId}&_include=Encounter:location`, { flat: false });
                let locId = null;
                if(encData.entry) {
                    const enc = encData.entry.find(e => e.resource.resourceType === "Encounter");
                    if(enc && enc.resource.location) locId = enc.resource.location[0].location.reference.split("/").pop();
                }
                if (!locId) throw new Error("æ‰¾ä¸åˆ°ä½é™¢ç´€éŒ„");

                // 2. æŠ“å…¨ç—…æˆ¿è³‡æ–™
                const query = `Encounter?location=${locId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=200`;
                const bundle = await fhirClient.request(query, { flat: false });

                // 3. è§£æ
                const patients = {}; 
                const infectedMap = {};

                if (bundle.entry) {
                    // åˆå§‹åŒ–æ‰€æœ‰ç—…äººç‚ºã€Œæ¥è§¸è€… (Contact)ã€
                    bundle.entry.forEach(e => {
                        if (e.resource.resourceType === "Patient") {
                            const p = e.resource;
                            const name = p.name?.[0]?.text || "Unknown";
                            patients[p.id] = { id: p.id, name: name, type: 'contact', date: null };
                        }
                    });

                    // æ¨™è¨˜ã€Œæ„ŸæŸ“è€… (Infected)ã€
                    bundle.entry.forEach(e => {
                        if (e.resource.resourceType === "Observation") {
                            const obs = e.resource;
                            const raw = JSON.stringify(obs).toLowerCase();
                            if (raw.includes(orgType.toLowerCase())) {
                                const patId = obs.subject?.reference?.split("/").pop();
                                if (patients[patId]) {
                                    patients[patId].type = 'infected';
                                    patients[patId].date = obs.effectiveDateTime?.substring(0, 10) || "9999";
                                }
                            }
                        }
                    });
                }

                // 4. ç¹ªåœ–æ•¸æ“š
                const nodes = Object.values(patients).map(p => ({
                    data: {
                        id: p.id,
                        label: p.type === 'infected' ? `${p.name}\n${p.date}` : p.name,
                        type: p.type,
                        isRoot: p.id === rootId
                    }
                }));

                const edges = [];
                const patList = Object.values(patients);
                
                // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ­£ï¼šé€£ç·šé‚è¼¯ â˜…â˜…â˜…
                for (let i = 0; i < patList.length; i++) {
                    for (let j = i + 1; j < patList.length; j++) {
                        const a = patList[i];
                        const b = patList[j];

                        // æƒ…å¢ƒ 1: ç´… <-> ç´… (å…©è€…çš†æ„ŸæŸ“) -> ç•«ç®­é ­
                        if (a.type === 'infected' && b.type === 'infected') {
                            if (a.date < b.date) edges.push({ data: { source: a.id, target: b.id, type: 'arrow' } });
                            else if (b.date < a.date) edges.push({ data: { source: b.id, target: a.id, type: 'arrow' } });
                            else edges.push({ data: { source: a.id, target: b.id, type: 'dashed' } }); // åŒä¸€å¤©
                        } 
                        // æƒ…å¢ƒ 2: ç´… <-> è— (åƒ…ä¸€æ–¹æ„ŸæŸ“) -> ç•«è™›ç·š (å¾ç´…é€£åˆ°è—)
                        else if (a.type === 'infected' && b.type === 'contact') {
                            edges.push({ data: { source: a.id, target: b.id, type: 'dashed' } });
                        }
                        else if (a.type === 'contact' && b.type === 'infected') {
                            edges.push({ data: { source: b.id, target: a.id, type: 'dashed' } });
                        }
                        // æƒ…å¢ƒ 3: è— <-> è— (çš†æœªæ„ŸæŸ“) -> ã€ä¸ç•«ç·šã€‘
                        else {
                            // Do nothing
                        }
                    }
                }

                status.textContent = `å®Œæˆï¼š${nodes.length} äºº (æ„ŸæŸ“ ${nodes.filter(n=>n.data.type==='infected').length} äºº)`;
                renderCy(nodes, edges);

            } catch (err) {
                console.error(err);
                status.textContent = "éŒ¯èª¤: " + err.message;
            } finally {
                btn.disabled = false;
            }
        }

        function renderCy(nodes, edges) {
            cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes, edges },
                style: [
                    { selector: 'node', style: { 'label': 'data(label)', 'text-wrap': 'wrap', 'text-valign': 'center', 'text-halign': 'center', 'color': '#fff' } },
                    // ç´…è‰²åœ“å½¢
                    { selector: 'node[type="infected"]', style: { 'shape': 'ellipse', 'background-color': '#e74c3c', 'width': 70, 'height': 70 } },
                    // è—è‰²æ–¹å½¢
                    { selector: 'node[type="contact"]', style: { 'shape': 'rectangle', 'background-color': '#3498db', 'width': 60, 'height': 60 } },
                    // æ ¸å¿ƒç—…äººåŠ ç²—
                    { selector: 'node[?isRoot]', style: { 'border-width': 4, 'border-color': '#f1c40f' } },
                    // ç®­é ­ (å‚³æ’­)
                    { selector: 'edge[type="arrow"]', style: { 'width': 3, 'line-color': '#e74c3c', 'target-arrow-color': '#e74c3c', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' } },
                    // è™›ç·š (æ¥è§¸)
                    { selector: 'edge[type="dashed"]', style: { 'width': 2, 'line-color': '#95a5a6', 'line-style': 'dashed', 'curve-style': 'bezier' } }
                ],
                layout: { name: 'cose', animate: true, padding: 50, nodeRepulsion: 10000 }
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾æº–å‚³æ’­éˆ (æ™‚é–“é‡ç–Šåˆ¤å®šç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #cy { width: 100%; height: 650px; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
        button { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        button:disabled { background: #cfd8dc; color: #90a4ae; cursor: not-allowed; }
        select, input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; }
        .legend { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 0.9rem; line-height: 1.8; }
        .dot { display: inline-block; width: 12px; height: 12px; margin-right: 5px; vertical-align: middle; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¥ é™¢å…§æ„ŸæŸ“å‚³æ’­éˆ (Time Overlap Logic)</h1>
        
        <div class="controls">
            <label>æ ¸å¿ƒç—…äºº IDï¼š</label>
            <input type="text" id="root-id" placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: 670653)" style="width: 150px;">
            
            <label>ç›®æ¨™èŒç¨®ï¼š</label>
            <select id="organism">
                <option value="ALL">å…¨éƒ¨ (All)</option>
                <option value="MRSA">Staphylococcus aureus (MRSA)</option>
                <option value="CRAB">Acinetobacter baumannii (CRAB)</option>
                <option value="VRE">Enterococcus faecium (VRE)</option>
                <option value="CRPA">Pseudomonas aeruginosa (CRPA)</option>
                <option value="CRE_COLI">E.coli (CR)</option>
                <option value="CRKP">Klebsiella pneumoniae (CR)</option>
            </select>

            <button id="btn-draw" onclick="runAnalysis()">ğŸš€ é–‹å§‹åˆ†æ</button>
            <span id="status" style="color: #d32f2f; font-weight: bold; margin-left: 10px;"></span>
        </div>

        <div id="cy"></div>
        
        <div class="legend">
            <b>åœ–ä¾‹èªªæ˜ï¼š</b><br>
            <span class="dot" style="background:#e74c3c; border-radius:50%;"></span><b>åœ“å½¢ (ç´…è‰²)</b>ï¼šæ„ŸæŸ“è€… (Infected) - å­—é«”é»‘è‰²<br>
            <span class="dot" style="background:#3498db;"></span><b>æ­£æ–¹å½¢ (è—è‰²)</b>ï¼šæ¥è§¸è€… (Contact) - å­—é«”é»‘è‰²<br>
            <b>â¡ å¯¦ç·šç®­é ­</b>ï¼šæ„ŸæŸ“å‚³æ’­ (ä¾ç…§æª¢é©—æ—¥æœŸï¼šå…ˆ â†’ å¾Œ)<br>
            <b>--- è™›ç·š</b>ï¼šæ¥è§¸é—œè¯ (åƒ…é™æ„ŸæŸ“è€… â†’ æ¥è§¸è€…ï¼Œä¸”å¿…é ˆä½é™¢æ™‚é–“é‡ç–Š)
        </div>
    </div>

    <script>
        let fhirClient = null;
        let cy = null; // Cytoscape å¯¦ä¾‹

        FHIR.oauth2.ready().then(c => { 
            fhirClient = c; 
            if(c.patient.id) document.getElementById("root-id").value = c.patient.id; 
        });

        // èŒç¨®é—œéµå­—å°æ‡‰è¡¨
        const BUG_KEYWORDS = {
            "MRSA": ["mrsa", "staphylococcus aureus"],
            "CRAB": ["crab", "acinetobacter", "baumannii"],
            "VRE": ["vre", "enterococcus", "faecium"],
            "CRPA": ["crpa", "pseudomonas", "aeruginosa"],
            "CRE_COLI": ["e.coli", "escherichia", "carbapenem"],
            "CRKP": ["klebsiella", "pneumoniae", "carbapenem"]
        };

        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgSelect = document.getElementById("organism").value;
            const btn = document.getElementById("btn-draw");
            const status = document.getElementById("status");

            if (!rootId) { alert("è«‹è¼¸å…¥æ ¸å¿ƒç—…äºº ID"); return; }
            btn.disabled = true;
            status.textContent = "ğŸ” 1/3 åˆ†æç—…æˆ¿èˆ‡ä½é™¢æ™‚é–“...";

            try {
                // 1. æŸ¥è©¢æ ¸å¿ƒç—…äººä½é™¢è³‡è¨Š (å–å¾— Location å’Œ æ™‚é–“å€é–“)
                const encQuery = `Encounter?subject=${rootId}&_include=Encounter:location`;
                const encBundle = await fhirClient.request(encQuery, { flat: false });
                
                let targetLocId = null;
                if(encBundle.entry) {
                    const enc = encBundle.entry.find(e => e.resource.resourceType === "Encounter");
                    if(enc && enc.resource.location && enc.resource.location.length > 0) {
                        const locRef = enc.resource.location[0].location.reference;
                        targetLocId = locRef.split("/").pop();
                    }
                }

                if (!targetLocId) throw new Error("æ‰¾ä¸åˆ°æ­¤ç—…äººçš„ä½é™¢ç—…æˆ¿è³‡è¨Š (Location)");

                // 2. æŠ“å–è©²ç—…æˆ¿ã€Œæ‰€æœ‰ã€ç›¸é—œäººäº‹ç‰© (æ“´å¤§æœå°‹ç¯„åœ)
                status.textContent = "ğŸ” 2/3 æƒæåŒç—…æˆ¿æ¥è§¸è€…...";
                // é€™è£¡æˆ‘å€‘æŠ“ 300 ç­†ï¼Œç¢ºä¿åŒ…å«åˆ°æ‰€æœ‰å¯èƒ½é‡ç–Šçš„äºº
                const query = `Encounter?location=${targetLocId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=300`;
                const bundle = await fhirClient.request(query, { flat: false });

                // 3. è³‡æ–™è§£æèˆ‡é‚è¼¯åˆ¤æ–·
                status.textContent = "ğŸ” 3/3 è¨ˆç®—æ™‚é–“é‡ç–Šèˆ‡å‚³æ’­è·¯å¾‘...";
                
                const patients = {}; 

                if (bundle.entry) {
                    // Step A: å»ºç«‹ç—…äººæ¸…å–®èˆ‡ä½é™¢æ™‚é–“
                    bundle.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Patient") {
                            const name = r.name?.[0]?.text || "Unknown";
                            if(!patients[r.id]) {
                                patients[r.id] = { 
                                    id: r.id, 
                                    name: name, 
                                    type: 'contact', // é è¨­ç‚ºæ¥è§¸è€…
                                    obsDate: null, 
                                    period: { start: null, end: null } 
                                };
                            }
                        }
                    });

                    // Step B: å¡«å…¥ Encounter æ™‚é–“ (ç”¨æ–¼æ¥è§¸åˆ¤å®š)
                    bundle.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Encounter") {
                            const patId = r.subject?.reference?.split("/").pop();
                            if (patients[patId] && r.period) {
                                // å„²å­˜ä½é™¢æ™‚é–“ï¼Œè‹¥ç„¡çµæŸæ™‚é–“å‰‡è¦–ç‚º '9999' (é‚„åœ¨ä½é™¢)
                                patients[patId].period = {
                                    start: new Date(r.period.start).getTime(),
                                    end: r.period.end ? new Date(r.period.end).getTime() : 9999999999999
                                };
                            }
                        }
                    });

                    // Step C: æ¨™è¨˜æ„ŸæŸ“è€… (Observation)
                    bundle.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Observation") {
                            const raw = JSON.stringify(r).toLowerCase();
                            // åˆ¤æ–·èŒç¨®
                            let isTarget = false;
                            if (orgSelect === "ALL") {
                                isTarget = true; // é€™è£¡ç°¡åŒ–ï¼Œå¯¦éš›å¯èƒ½è¦æ’é™¤é MDRO
                            } else {
                                const keywords = BUG_KEYWORDS[orgSelect];
                                if (keywords && keywords.every(k => raw.includes(k))) isTarget = true;
                            }

                            if (isTarget) {
                                const patId = r.subject?.reference?.split("/").pop();
                                if (patients[patId]) {
                                    patients[patId].type = 'infected';
                                    // ç´€éŒ„æª¢é©—æ—¥æœŸ (å–æœ€æ—©)
                                    const d = r.effectiveDateTime ? r.effectiveDateTime.substring(0, 10) : "9999";
                                    if (!patients[patId].obsDate || d < patients[patId].obsDate) {
                                        patients[patId].obsDate = d;
                                    }
                                }
                            }
                        }
                    });
                }

                // 4. å»ºç«‹åœ–è¡¨æ•¸æ“š
                const patList = Object.values(patients).filter(p => p.period.start); // éæ¿¾æ‰æ²’æœ‰ä½é™¢æ™‚é–“çš„äºº
                const nodes = patList.map(p => ({
                    data: {
                        id: p.id,
                        // æ„ŸæŸ“è€…é¡¯ç¤ºæ—¥æœŸï¼Œæ¥è§¸è€…ä¸é¡¯ç¤º
                        label: p.type === 'infected' ? `${p.name}\n${p.obsDate}` : p.name,
                        type: p.type,
                        isRoot: p.id === rootId
                    }
                }));

                const edges = [];

                // 5. é€£ç·šé‚è¼¯ (æ ¸å¿ƒæ¼”ç®—æ³•)
                for (let i = 0; i < patList.length; i++) {
                    for (let j = i + 1; j < patList.length; j++) {
                        const p1 = patList[i];
                        const p2 = patList[j];

                        // åˆ¤å®šæ™‚é–“é‡ç–Š (Time Overlap)
                        // å…¬å¼: (StartA <= EndB) and (EndA >= StartB)
                        const isOverlap = (p1.period.start <= p2.period.end) && (p1.period.end >= p2.period.start);

                        if (!isOverlap) continue; // æ²’æœ‰æ™‚é–“é‡ç–Šï¼Œç›´æ¥è·³éï¼Œä¸ç®—æ¥è§¸

                        // æƒ…å¢ƒ A: é›™æ–¹çš†æ„ŸæŸ“ (ç´… <-> ç´…) => å¯¦ç·šç®­é ­
                        if (p1.type === 'infected' && p2.type === 'infected') {
                            if (p1.obsDate < p2.obsDate) {
                                edges.push({ data: { source: p1.id, target: p2.id, type: 'transmit' } });
                            } else if (p2.obsDate < p1.obsDate) {
                                edges.push({ data: { source: p2.id, target: p1.id, type: 'transmit' } });
                            } else {
                                edges.push({ data: { source: p1.id, target: p2.id, type: 'concurrent' } }); // åŒæ—¥ç™¼ç¾
                            }
                        }
                        // æƒ…å¢ƒ B: ä¸€ç´…ä¸€è— (æ„ŸæŸ“ -> æ¥è§¸) => è™›ç·š
                        else if (p1.type === 'infected' && p2.type === 'contact') {
                            edges.push({ data: { source: p1.id, target: p2.id, type: 'contact' } });
                        }
                        else if (p2.type === 'infected' && p1.type === 'contact') {
                            edges.push({ data: { source: p2.id, target: p1.id, type: 'contact' } });
                        }
                        // æƒ…å¢ƒ C: è— <-> è— => ä¸é€£ç·š (ä¾æ‚¨è¦æ±‚)
                    }
                }

                status.textContent = `åˆ†æå®Œæˆï¼šå…± ${nodes.length} äººï¼Œæ„ŸæŸ“ ${nodes.filter(n=>n.data.type==='infected').length} äºº`;
                renderGraph(nodes, edges);

            } catch (err) {
                console.error(err);
                status.textContent = "éŒ¯èª¤: " + err.message;
            } finally {
                btn.disabled = false;
            }
        }

        function renderGraph(nodes, edges) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes, edges },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-wrap': 'wrap',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'color': '#000000', // â˜…â˜…â˜… ä¿®æ­£ï¼šå­—é«”å…¨é»‘ â˜…â˜…â˜…
                            'border-width': 2,
                            'border-color': '#333'
                        }
                    },
                    {
                        selector: 'node[type="infected"]',
                        style: { 'shape': 'ellipse', 'background-color': '#e74c3c', 'width': 80, 'height': 80 }
                    },
                    {
                        selector: 'node[type="contact"]',
                        style: { 'shape': 'rectangle', 'background-color': '#3498db', 'width': 70, 'height': 70 }
                    },
                    {
                        selector: 'node[?isRoot]', // æ ¸å¿ƒç—…äººåŠ ç²—é»ƒæ¡†
                        style: { 'border-width': 5, 'border-color': '#f1c40f' }
                    },
                    {
                        selector: 'edge[type="transmit"]',
                        style: { 'width': 4, 'line-color': '#e74c3c', 'target-arrow-color': '#e74c3c', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="contact"]',
                        style: { 'width': 2, 'line-color': '#95a5a6', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="concurrent"]',
                        style: { 'width': 4, 'line-color': '#e74c3c', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    // â˜…â˜…â˜… äº’å‹•æ¨£å¼ï¼šè¢«é¸ä¸­æ™‚ â˜…â˜…â˜…
                    {
                        selector: '.highlight',
                        style: {
                            'border-width': 4,
                            'border-color': '#000',
                            'font-size': '14px',
                            'z-index': 999
                        }
                    },
                    {
                        selector: '.faded', // æœªé¸ä¸­è®Šæš—
                        style: {
                            'opacity': 0.2,
                            'label': '' // éš±è—æ–‡å­—è®“ç•«é¢æ›´ä¹¾æ·¨
                        }
                    },
                    {
                        selector: 'edge.highlight',
                        style: { 'width': 6 }
                    }
                ],
                layout: { name: 'cose', animate: true, padding: 50, componentSpacing: 80 }
            });

            // â˜…â˜…â˜… é»æ“Šäº’å‹•é‚è¼¯ (Click Interaction) â˜…â˜…â˜…
            cy.on('tap', function(e) {
                if(e.target === cy){
                    // é»æ“Šç©ºç™½è™•ï¼Œé‡ç½®
                    cy.elements().removeClass('faded highlight');
                } else {
                    const node = e.target;
                    // å…ˆæŠŠæ‰€æœ‰äººè®Šæš—
                    cy.elements().addClass('faded');
                    
                    // åªæœ‰ã€Œé€™å€‹äººã€+ã€Œé€£å‡ºå»çš„ç·šã€+ã€Œé€£åˆ°çš„äººã€äº®èµ·ä¾†
                    const connectedEdges = node.outgoers('edge'); // åªæŠ“é€£å‡ºå»çš„ç·š? é‚„æ˜¯æ‰€æœ‰ç›¸é—œ? æ ¹æ“šéœ€æ±‚é€šå¸¸æ˜¯æ‰€æœ‰ç›¸é—œ
                    // ä¿®æ­£ï¼šé¡¯ç¤ºæ‰€æœ‰èˆ‡æ­¤ç¯€é»ç›´æ¥ç›¸é€£çš„é—œä¿‚ (é›™å‘)
                    const neighborhood = node.neighborhood().add(node);
                    
                    neighborhood.removeClass('faded').addClass('highlight');
                }
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é†«é™¢æ„ŸæŸ“å‚³æ’­éˆåˆ†æç³»çµ± (MDRO Tracer)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --danger: #e74c3c;
            --success: #2ecc71;
            --bg: #f8f9fa;
            --card-bg: #ffffff;
        }

        body { font-family: "Segoe UI", "Microsoft JhengHei", sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1280px; margin: 0 auto; display: grid; grid-template-rows: auto auto 1fr; gap: 20px; height: 95vh; }
        
        /* æ¨™é¡Œå€ */
        header { background: var(--card-bg); padding: 15px 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 1.5rem; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .badge { background: var(--accent); color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; vertical-align: middle; }

        /* æ§åˆ¶é¢æ¿ */
        .controls { background: var(--card-bg); padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }
        
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        label { font-weight: 600; font-size: 0.9rem; color: #555; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; outline: none; transition: border 0.3s; }
        input:focus, select:focus { border-color: var(--accent); }
        
        button { background: var(--accent); color: white; border: none; padding: 10px 25px; border-radius: 6px; font-weight: bold; cursor: pointer; transition: transform 0.1s, background 0.3s; font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        button:hover { background: #2980b9; transform: translateY(-1px); }
        button:active { transform: translateY(1px); }
        button:disabled { background: #bdc3c7; cursor: not-allowed; transform: none; }

        /* ä¸»ç•«é¢ä½ˆå±€ */
        .main-content { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; min-height: 500px; }
        
        /* åœ–è¡¨å€ */
        #cy-container { background: var(--card-bg); border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; overflow: hidden; border: 1px solid #eee; }
        #cy { width: 100%; height: 100%; }
        
        /* ç‹€æ…‹èˆ‡æ—¥èªŒå€ */
        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .status-card { background: var(--card-bg); padding: 15px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .status-title { font-weight: bold; margin-bottom: 10px; display: block; border-bottom: 2px solid #f0f0f0; padding-bottom: 5px; }
        
        #log-window { background: #1e1e1e; color: #a9b7c6; padding: 15px; border-radius: 8px; height: 100%; overflow-y: auto; font-family: "Consolas", monospace; font-size: 0.85rem; line-height: 1.4; max-height: 600px; }
        .log-time { color: #808080; margin-right: 8px; }
        .log-info { color: #6a8759; }
        .log-warn { color: #cc7832; }
        .log-error { color: #ff6b68; font-weight: bold; }
        .log-highlight { color: #6897bb; font-weight: bold; }

        /* è®€å–å‹•ç•« */
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid var(--accent); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>ğŸ¦  é†«é™¢æ„ŸæŸ“å‚³æ’­éˆåˆ†æç³»çµ± <span class="badge">FHIR R4</span></h1>
            <div id="connection-status" style="color: gray; font-size: 0.9rem;">ç­‰å¾…é€£ç·š...</div>
        </header>

        <div class="controls">
            <div class="input-group">
                <label>æ ¸å¿ƒç—…äºº ID (Index Patient)</label>
                <input type="text" id="root-id" placeholder="ä¾‹å¦‚: 669814" style="width: 180px;">
            </div>
            
            <div class="input-group">
                <label>ç›®æ¨™èŒç¨® (Target Organism)</label>
                <select id="organism" style="width: 200px;">
                    <option value="MRSA">MRSA (Staphylococcus aureus)</option>
                    <option value="CRAB">CRAB (Acinetobacter baumannii)</option>
                    <option value="VRE">VRE (Enterococcus faecium)</option>
                    <option value="ALL">å…¨éƒ¨é¡¯ç¤º (All MDROs)</option>
                </select>
            </div>

            <div style="align-self: flex-end;">
                <button id="btn-draw" onclick="runAnalysis()">
                    <div class="loader" id="btn-loader"></div>
                    <span>é–‹å§‹åˆ†æå‚³æ’­éˆ</span>
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="cy-container">
                <div id="cy"></div>
                <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(255,255,255,0.9); padding: 10px; border-radius: 8px; font-size: 0.8rem; pointer-events: none;">
                    <span style="color:#e74c3c;">â—</span> æ ¸å¿ƒç—…äºº &nbsp; 
                    <span style="color:#3498db;">â– </span> æ¥è§¸è€…/å®¤å‹
                </div>
            </div>

            <div class="sidebar">
                <div class="status-card">
                    <span class="status-title">åˆ†æç‹€æ…‹</span>
                    <div id="status-text" style="color: #666;">ç³»çµ±æº–å‚™å°±ç·’ï¼Œè«‹è¼¸å…¥ ID é–‹å§‹æŸ¥è©¢ã€‚</div>
                </div>
                <div id="log-window">
                    <div>ç³»çµ±å•Ÿå‹•...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ç³»çµ±å…¨åŸŸè®Šæ•¸ ---
        let fhirClient = null;
        let cy = null;

        // --- å·¥å…·å‡½å¼ï¼šæ—¥èªŒè¨˜éŒ„ ---
        function log(msg, type = 'info') {
            const logWin = document.getElementById("log-window");
            const time = new Date().toLocaleTimeString();
            const div = document.createElement("div");
            
            let typeClass = "log-info";
            if(type === 'error') typeClass = "log-error";
            if(type === 'warn') typeClass = "log-warn";
            if(type === 'highlight') typeClass = "log-highlight";

            div.innerHTML = `<span class="log-time">[${time}]</span> <span class="${typeClass}">${msg}</span>`;
            logWin.appendChild(div);
            logWin.scrollTop = logWin.scrollHeight;
        }

        // --- å·¥å…·å‡½å¼ï¼šID è§£æ ---
        function cleanId(reference) {
            if (!reference) return null;
            return reference.includes('/') ? reference.split('/').pop() : reference;
        }

        // --- åˆå§‹åŒ– FHIR Client ---
        FHIR.oauth2.ready().then(client => {
            fhirClient = client;
            document.getElementById("connection-status").innerHTML = `âœ… å·²é€£ç·šè‡³: ${client.state.serverUrl}`;
            document.getElementById("connection-status").style.color = "green";
            log("FHIR Client åˆå§‹åŒ–æˆåŠŸ", "highlight");
            
            // å¦‚æœ Launch Context æœ‰ç—…äºº IDï¼Œè‡ªå‹•å¡«å…¥
            if (client.patient.id) {
                document.getElementById("root-id").value = client.patient.id;
                log(`åµæ¸¬åˆ° Context ç—…äºº ID: ${client.patient.id}`);
            }
        }).catch(err => {
            document.getElementById("connection-status").innerHTML = `âŒ é€£ç·šå¤±æ•—`;
            document.getElementById("connection-status").style.color = "red";
            log(`FHIR åˆå§‹åŒ–å¤±æ•—: ${err}`, "error");
        });

        // --- æ ¸å¿ƒåˆ†æé‚è¼¯ ---
        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgType = document.getElementById("organism").value;
            const btn = document.getElementById("btn-draw");
            const loader = document.getElementById("btn-loader");
            const statusText = document.getElementById("status-text");

            if (!rootId) {
                alert("è«‹è¼¸å…¥ç—…äºº IDï¼");
                return;
            }
            if (!fhirClient) {
                alert("FHIR Client å°šæœªé€£ç·šï¼Œè«‹æª¢æŸ¥ç’°å¢ƒã€‚");
                return;
            }

            // UI ç‹€æ…‹é‡ç½®
            btn.disabled = true;
            loader.style.display = "inline-block";
            document.getElementById("log-window").innerHTML = ""; // æ¸…ç©ºèˆŠ log
            log(`ğŸš€ é–‹å§‹åˆ†æç—…äºº: ${rootId}, èŒç¨®: ${orgType}`, "highlight");

            try {
                // 1. æŸ¥è©¢æ ¸å¿ƒç—…äººèˆ‡ä½é™¢ç´€éŒ„
                statusText.textContent = "éšæ®µ 1/3: æŸ¥è©¢ç—…äººä½é™¢å²...";
                
                // ä¸¦è¡ŒæŸ¥è©¢ç—…äººè³‡æ–™èˆ‡ Encounter
                const [patientRes, encounterBundle] = await Promise.all([
                    fhirClient.request(`Patient/${rootId}`).catch(() => null),
                    fhirClient.request(`Encounter?subject=${rootId}&_include=Encounter:location`, { flat: false })
                ]);

                if (!patientRes) throw new Error("æ‰¾ä¸åˆ°è©²ç—…äºº ID");
                const rootName = patientRes.name?.[0]?.text || 
                               (patientRes.name?.[0]?.family + patientRes.name?.[0]?.given?.join("")) || "Unknown";
                log(`âœ… ç¢ºèªç—…äºº: ${rootName}`);

                if (!encounterBundle.entry || encounterBundle.entry.length === 0) {
                    throw new Error("æ­¤ç—…äººæ²’æœ‰ä»»ä½•ä½é™¢ç´€éŒ„ (Encounter)ï¼Œç„¡æ³•è¿½è¹¤æ¥è§¸è€…ã€‚");
                }

                // 2. æå–ä½éçš„ç—…æˆ¿ (Location)
                const locationMap = new Map(); // ID -> Name
                const targetLocIds = new Set();

                encounterBundle.entry.forEach(e => {
                    const res = e.resource;
                    // å»ºç«‹ Location åƒç…§è¡¨
                    if (res.resourceType === "Location") {
                        locationMap.set(res.id, res.name || res.alias?.[0] || "æœªçŸ¥ç—…æˆ¿");
                    }
                    // è§£æ Encounter ä¸­çš„ Location
                    if (res.resourceType === "Encounter" && res.location) {
                        res.location.forEach(locWrapper => {
                            const ref = locWrapper.location?.reference;
                            const display = locWrapper.location?.display;
                            if (ref) {
                                const id = cleanId(ref);
                                targetLocIds.add(id);
                                if (!locationMap.has(id) && display) {
                                    locationMap.set(id, display);
                                }
                            }
                        });
                    }
                });

                if (targetLocIds.size === 0) throw new Error("ä½é™¢ç´€éŒ„ä¸­æœªåŒ…å«ç—…æˆ¿ (Location) è³‡è¨Šã€‚");
                
                const locIdsArr = Array.from(targetLocIds);
                log(`ğŸ“ é–å®š ${locIdsArr.length} å€‹ç›¸é—œç—…æˆ¿: ${Array.from(locationMap.values()).join(", ")}`);

                // 3. åæŸ¥é€™äº›ç—…æˆ¿çš„æ‰€æœ‰æ¥è§¸è€… (Magic Query)
                statusText.textContent = `éšæ®µ 2/3: æƒæ ${locIdsArr.length} å€‹ç—…æˆ¿çš„æ¥è§¸è€…...`;
                
                // ä½¿ç”¨ Promise.all ä¸¦è¡ŒæŸ¥è©¢æ‰€æœ‰ç—…æˆ¿
                const queryPromises = locIdsArr.map(locId => {
                    // é—œéµæŸ¥è©¢ï¼šEncounter + Patient + Observation (ä¸€æ¬¡æŠ“å›)
                    const q = `Encounter?location=${locId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=300`;
                    log(`ğŸ” æƒæç—…æˆ¿ ${locationMap.get(locId) || locId}...`);
                    return fhirClient.request(q, { flat: false });
                });

                const bundles = await Promise.all(queryPromises);

                // 4. è³‡æ–™è™•ç†èˆ‡éæ¿¾
                statusText.textContent = "éšæ®µ 3/3: å»ºæ§‹å‚³æ’­ç¶²è·¯...";
                
                const nodes = new Map(); // ID -> NodeData
                const edges = new Set(); // "source-target" string to avoid duplicates

                // å»ºç«‹å…¨åŸŸç´¢å¼•
                const allPatients = new Map();
                const allObs = [];

                bundles.forEach(b => {
                    if (!b.entry) return;
                    b.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Patient") allPatients.set(r.id, r);
                        if (r.resourceType === "Observation") allObs.push(r);
                    });
                });

                log(`ğŸ“¦ åŸå§‹è³‡æ–™: ${allPatients.size} ä½ç—…äºº, ${allObs.length} ä»½å ±å‘Š`);

                // åˆ†æ Observation
                allObs.forEach(obs => {
                    // 4.1 èŒç¨®éæ¿¾
                    const rawText = JSON.stringify(obs).toLowerCase();
                    if (orgType !== "ALL" && !rawText.includes(orgType.toLowerCase())) return;

                    // 4.2 å–å¾—ç—…äºº ID
                    const patId = cleanId(obs.subject?.reference);
                    if (!patId || !allPatients.has(patId)) return;

                    // 4.3 å»ºç«‹ç¯€é»è³‡æ–™
                    const patient = allPatients.get(patId);
                    // çµ„åˆå§“åï¼šå„ªå…ˆä½¿ç”¨ textï¼Œå¦å‰‡ç”¨ family+given
                    let name = patient.name?.[0]?.text;
                    if (!name && patient.name?.[0]) {
                        name = (patient.name[0].family || "") + (patient.name[0].given?.join("") || "");
                    }
                    name = name || "Unknown";

                    const date = obs.effectiveDateTime ? obs.effectiveDateTime.substring(0, 10) : "ç„¡æ—¥æœŸ";
                    
                    // å˜—è©¦æ‰¾å‡ºé€™ä»½å ±å‘Šå°æ‡‰çš„ç—…æˆ¿åç¨±
                    // é€™è£¡ç°¡åŒ–é‚è¼¯ï¼šå¦‚æœé€™å€‹ Observation å±¬æ–¼æˆ‘å€‘æŸ¥å›ä¾†çš„ Encounterï¼Œå°±æ¨™è¨˜è©² Encounter çš„ Location
                    // å¯¦å‹™ä¸Šå¯ä»¥ç›´æ¥æ¨™ç¤º "ç›¸é—œæ¥è§¸è€…"
                    
                    nodes.set(patId, {
                        id: patId,
                        name: name,
                        date: date,
                        isRoot: patId === rootId
                    });
                });

                if (nodes.size === 0) {
                    log("âŒ ç¯©é¸å¾Œç„¡ç¬¦åˆè³‡æ–™", "warn");
                    statusText.textContent = "æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„æ¥è§¸è€…";
                    drawGraph([], []); // æ¸…ç©ºåœ–è¡¨
                    return;
                }

                // 4.4 å»ºç«‹é€£ç·š (åªè¦æ—¥æœŸç›¸åŒä¸”éƒ½åœ¨é€™æ‰¹ Location æ’ˆå›ä¾†çš„æ¸…å–®ä¸­ï¼Œè¦–ç‚ºæ¥è§¸)
                const nodeList = Array.from(nodes.values());
                
                for (let i = 0; i < nodeList.length; i++) {
                    for (let j = i + 1; j < nodeList.length; j++) {
                        const a = nodeList[i];
                        const b = nodeList[j];
                        
                        // åˆ¤å®šé‚è¼¯ï¼šæ—¥æœŸç›¸åŒ (å› ç‚ºæˆ‘å€‘å·²ç¶“é™å®šæ˜¯åŒç—…æˆ¿çš„æŸ¥è©¢çµæœäº†)
                        if (a.date === b.date && a.date !== "ç„¡æ—¥æœŸ") {
                            // ç¢ºä¿é€£ç·šæ–¹å‘ä¸€è‡´ (é¿å…é‡è¤‡)
                            edges.add(`${a.id}|${b.id}`); 
                        }
                    }
                }

                log(`ğŸ“Š åˆ†æå®Œæˆ: ${nodes.size} å€‹ç¯€é», ${edges.size} æ¢é€£ç·š`, "highlight");
                statusText.textContent = `åˆ†æå®Œæˆï¼å…± ${nodes.size} äºº`;

                // 5. ç¹ªè£½åœ–è¡¨
                drawGraph(nodeList, Array.from(edges));

            } catch (err) {
                console.error(err);
                log(`éŒ¯èª¤: ${err.message}`, "error");
                statusText.textContent = "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŸ¥çœ‹æ—¥èªŒ";
                alert("åˆ†æéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
            } finally {
                btn.disabled = false;
                loader.style.display = "none";
            }
        }

        // --- Cytoscape ç¹ªåœ–é‚è¼¯ ---
        function drawGraph(nodeList, edgeList) {
            const elements = [];

            // è½‰æ›ç¯€é»
            nodeList.forEach(n => {
                elements.push({
                    data: {
                        id: n.id,
                        label: `${n.name}\n${n.date}`,
                        type: n.isRoot ? 'root' : 'contact'
                    }
                });
            });

            // è½‰æ›é€£ç·š
            edgeList.forEach((edgeStr, index) => {
                const [source, target] = edgeStr.split('|');
                elements.push({
                    data: {
                        id: 'e' + index,
                        source: source,
                        target: target
                    }
                });
            });

            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: elements,
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-wrap': 'wrap',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'color': '#fff',
                            'border-width': 2,
                            'border-color': '#2c3e50'
                        }
                    },
                    {
                        selector: 'node[type="root"]',
                        style: {
                            'background-color': '#e74c3c', // ç´…è‰²åœ“å½¢
                            'shape': 'ellipse',
                            'width': 70,
                            'height': 70,
                            'font-weight': 'bold'
                        }
                    },
                    {
                        selector: 'node[type="contact"]',
                        style: {
                            'background-color': '#3498db', // è—è‰²æ–¹å½¢
                            'shape': 'round-rectangle',
                            'width': 65,
                            'height': 65
                        }
                    },
                    {
                        selector: 'edge',
                        style: {
                            'width': 3,
                            'line-color': '#95a5a6',
                            'curve-style': 'bezier'
                        }
                    }
                ],
                // ä½¿ç”¨ cose ä½ˆå±€æ¼”ç®—æ³•ï¼Œè®“åœ–å½¢è‡ªå‹•æ•£é–‹
                layout: {
                    name: 'cose',
                    animate: true,
                    padding: 50,
                    nodeRepulsion: 4500,
                    idealEdgeLength: 100
                }
            });

            // é»æ“Šäº‹ä»¶
            cy.on('tap', 'node', function(evt){
                const node = evt.target;
                log(`é»æ“Šç¯€é»: ${node.data('label').replace('\n', ', ')}`);
            });
        }
    </script>
</body>
</html>
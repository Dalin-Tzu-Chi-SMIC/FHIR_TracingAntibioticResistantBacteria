<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>疫調傳播鏈 SMART App (FHIR Sandbox)</title>

    <!-- SMART on FHIR JS 客戶端 -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

    <!-- Cytoscape.js：用來畫關係圖 -->
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei",
          sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f7;
      }

      header {
        background: #003366;
        color: #fff;
        padding: 1rem 1.5rem;
      }

      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      header small {
        display: block;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      main {
        padding: 1rem 1.5rem 2rem 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
      }

      .card h2 {
        margin-top: 0;
        font-size: 1.1rem;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 0.3rem;
        margin-bottom: 0.5rem;
      }

      .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem 2rem;
        font-size: 0.9rem;
      }

      .meta-label {
        font-weight: 600;
      }

      #cy {
        width: 100%;
        height: 500px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      .stats {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 0.5rem;
      }

      button {
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        border: none;
        background: #003366;
        color: #fff;
        cursor: pointer;
        font-size: 0.85rem;
      }

      button:hover {
        background: #004a99;
      }

      button:disabled {
        background: #9e9e9e;
        cursor: not-allowed;
      }

      select,
      input[type="text"] {
        padding: 0.25rem 0.5rem;
        border-radius: 999px;
        border: 1px solid #ccc;
        font-size: 0.85rem;
      }

      .error {
        color: #b00020;
        font-weight: 600;
      }

      pre {
        background: #111827;
        color: #e5e7eb;
        padding: 0.7rem;
        border-radius: 6px;
        font-size: 0.8rem;
        overflow: auto;
        max-height: 260px;
      }

      @media (max-width: 768px) {
        main {
          padding: 0.8rem;
        }
        #cy {
          height: 420px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>疫調傳播鏈 SMART App</h1>
      <small>從 FHIR(Observation / Encounter) 組出人對人的傳播鏈</small>
    </header>

    <main>
      <!-- FHIR 連線資訊 -->
      <section class="card">
        <h2>FHIR 連線資訊</h2>
        <div id="meta-content" class="meta-row">
          <span>初始化中...</span>
        </div>
      </section>

      <!-- 傳播鏈圖 -->
      <section class="card">
        <h2>傳播鏈關係圖（人 ↔ 人）</h2>

        <div class="stats" id="graph-stats">尚未載入 FHIR 資料</div>

        <!-- 上方操作區：菌種選擇 + 起始病人ID -->
        <div
          style="
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
          "
        >
          <label for="sel-organism" style="font-size: 0.85rem;">選擇抗藥菌株：</label>
          <select id="sel-organism">
            <option value="ALL">全部菌種（不過濾）</option>
            <option value="CRAB">Acinetobacter baumannii(CRAB)</option>
            <option value="E_COLI_CR">E.coli (CR)</option>
            <option value="VRE">Enterococcus faecium(VRE)</option>
            <option value="KP_CR">Klebsiella pneumoniae (CR)</option>
            <option value="CRPA">Pseudomonas aeruginosa(CRPA)</option>
            <option value="MRSA">Staphylococcus aureus(MRSA)</option>
          </select>

          <span style="font-size: 0.85rem; margin-left: 0.5rem;">起始病人 ID：</span>
          <input
            type="text"
            id="txt-root-patient"
            placeholder="例如：130206"
            style="min-width: 110px;"
          />
          <button id="btn-apply-root">以此病人為起點重建</button>

          <button id="btn-reload-graph">重新從 FHIR 重建（不指定起點）</button>
        </div>

        <div style="font-size: 0.8rem; color: #555; margin-bottom: 0.5rem;">
          邏輯：從多位病人的實驗室 Observation 中找出抗藥菌事件，依「病房 + 菌種 + 日期」判定
          共同接觸點，只畫<b>人 ↔ 人</b>的傳播線。<br />
          若輸入起始病人 ID，則只顯示與該病人「在同一條傳播鏈上」的病人群組，並將其標為 No.1。
        </div>

        <div id="cy"></div>
      </section>

      <!-- 除錯 / JSON -->
      <section class="card">
        <h2>除錯訊息 / 原始 JSON</h2>
        <button id="btn-clear-debug">清除訊息</button>
        <pre id="debug-log">// 這裡會顯示 client 狀態、錯誤訊息與部分原始 JSON</pre>
      </section>
    </main>

    <script>
      /********** 抗藥菌株選項設定 **********/
      const BACTERIA_OPTIONS = [
        {
          id: "ALL",
          label: "全部菌種（不過濾）",
          keywords: []
        },
        {
          id: "CRAB",
          label: "Acinetobacter baumannii(CRAB)",
          keywords: ["acinetobacter", "baumannii", "crab"]
        },
        {
          id: "E_COLI_CR",
          label: "E.coli (CR)",
          keywords: ["e.coli", "escherichia coli", "cr e.coli"]
        },
        {
          id: "VRE",
          label: "Enterococcus faecium(VRE)",
          keywords: ["enterococcus faecium", "vre"]
        },
        {
          id: "KP_CR",
          label: "Klebsiella pneumoniae (CR)",
          keywords: ["klebsiella pneumoniae", "cr kp", "cr klebsiella"]
        },
        {
          id: "CRPA",
          label: "Pseudomonas aeruginosa(CRPA)",
          keywords: ["pseudomonas aeruginosa", "crpa"]
        },
        {
          id: "MRSA",
          label: "Staphylococcus aureus(MRSA)",
          keywords: ["staphylococcus aureus", "mrsa"]
        }
      ];

      function getSelectedBacteriaOption() {
        const sel = document.getElementById("sel-organism");
        const val = sel.value || "ALL";
        return BACTERIA_OPTIONS.find((x) => x.id === val) || BACTERIA_OPTIONS[0];
      }

      /********** 小工具：Debug Log **********/
      function logDebug(obj, title) {
        const pre = document.getElementById("debug-log");
        const now = new Date().toISOString();
        let text = pre.textContent || "";
        text += `\n\n[${now}] ${title || "訊息"}\n`;
        try {
          text += typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
        } catch {
          text += String(obj);
        }
        pre.textContent = text;
      }

      /********** 小工具：Mask 病人名稱 / ID **********/
      function maskName(name) {
        if (!name) return "";
        const s = name.trim();
        if (s.length === 1) return s + "○";
        if (s.length === 2) return s[0] + "○";
        return s[0] + "○" + s.slice(2);
      }

      function shortId(id) {
        if (!id) return "";
        const s = String(id);
        if (s.length <= 4) return s;
        return s.slice(0, 2) + "…" + s.slice(-2);
      }

      /********** 判斷：Observation 是否為抗藥菌 / 感染相關 **********/
      function isAntibioticRelatedObservation(obs) {
        if (!obs || !obs.code) return false;

        const code = obs.code;
        const text = (code.text || "").toLowerCase();
        const codings = code.coding || [];
        const codingStr = codings
          .map((c) => `${c.system || ""}|${c.code || ""}|${c.display || ""}`.toLowerCase())
          .join(" ");

        const valueString = (obs.valueString || "").toLowerCase();
        const valueConceptText =
          (obs.valueCodeableConcept && obs.valueCodeableConcept.text)
            ? obs.valueCodeableConcept.text.toLowerCase()
            : "";

        const haystack = `${text} ${codingStr} ${valueString} ${valueConceptText}`;

        const mdroKeywords = [
          "mrsa",
          "vre",
          "acinetobacter",
          "baumannii",
          "crab",
          "pseudomonas",
          "crpa",
          "klebsiella",
          "e.coli",
          "escherichia coli",
          "carbapenem",
          " resistant",
          "多重抗藥",
          "mdro"
        ];

        if (mdroKeywords.some((k) => haystack.includes(k))) {
          return true;
        }

        // 補充：interpretation 有 R 或 Resistant 也算
        const interpCodes = (obs.interpretation || []).flatMap((i) =>
          (i.coding || []).map((c) => (c.code || "").toUpperCase())
        );
        if (interpCodes.includes("R")) return true;

        const interpText = (obs.interpretation || [])
          .map((i) => (i.text || "").toLowerCase())
          .join(" ");
        if (interpText.includes("resistan")) return true;

        return false;
      }

      /********** 判斷：Observation 是否符合下拉選到的菌種 **********/
      function isObservationMatchBacteria(obs, organismText, bacteriaOption) {
        if (!bacteriaOption || bacteriaOption.id === "ALL") return true;
        const hay =
          `${organismText || ""} ${(obs.valueString || "")}`.toLowerCase();
        if (!hay) return false;
        return bacteriaOption.keywords.some((k) => hay.includes(k));
      }

      /********** 畫 FHIR 連線資訊 **********/
      function renderMeta(client) {
        const div = document.getElementById("meta-content");
        const st = client.state || {};
        const url = st.serverUrl || "(未知)";
        const token = st.tokenResponse || {};
        const patientId = st.patientId || (client.patient && client.patient.id);

        div.innerHTML = `
          <div>
            <span class="meta-label">FHIR Server：</span>
            <span>${url}</span>
          </div>
          <div>
            <span class="meta-label">Access Token：</span>
            <span>${token.access_token ? "已取得" : "尚未取得 / 不需 token"}</span>
          </div>
          <div>
            <span class="meta-label">Patient Id (context)：</span>
            <span>${patientId || "(無病人 context 或為 system/user app)"}</span>
          </div>
          <div>
            <span class="meta-label">Scope：</span>
            <span>${st.tokenResponse?.scope || "(未知)"}</span>
          </div>
        `;
      }

      /********** 從 FHIR 建立傳播鏈所需的資料結構（多病人） **********/
      async function buildTransmissionData(client, bacteriaOption) {
        const url =
          "Observation?category=laboratory&_count=50" +
          "&_include=Observation:subject" +
          "&_include=Observation:encounter" +
          "&_include:iterate=Encounter:location";

        const bundle = await client.request(url, { flat: false });
        logDebug(bundle, "Observation Bundle（多病人，laboratory）");

        const entries = bundle.entry || [];
        const patientsById = {};
        const encountersById = {};
        const locationsById = {};
        const observations = [];

        for (const e of entries) {
          const res = e.resource;
          if (!res || !res.resourceType) continue;
          switch (res.resourceType) {
            case "Observation":
              observations.push(res);
              break;
            case "Patient":
              patientsById[res.id] = res;
              break;
            case "Encounter":
              encountersById[res.id] = res;
              break;
            case "Location":
              locationsById[res.id] = res;
              break;
          }
        }

        const cases = [];

        for (const obs of observations) {
          if (!isAntibioticRelatedObservation(obs)) continue;

          const subjRef = obs.subject && obs.subject.reference;
          if (!subjRef || !subjRef.startsWith("Patient/")) continue;
          const patientId = subjRef.split("/")[1];
          const patientRes = patientsById[patientId];

          // Encounter + Location/病房
          let wardName = "";
          let enc = null;

          const encRef = obs.encounter && obs.encounter.reference;
          if (encRef && encRef.startsWith("Encounter/")) {
            const encId = encRef.split("/")[1];
            enc = encountersById[encId] || null;
          }

          if (enc) {
            if (enc.location && enc.location.length > 0) {
              const locRef = enc.location[0].location && enc.location[0].location.reference;
              const locDisplay =
                (enc.location[0].location && enc.location[0].location.display) || "";
              if (locDisplay) wardName = locDisplay;
              if (!wardName && locRef && locRef.startsWith("Location/")) {
                const locId = locRef.split("/")[1];
                const locRes = locationsById[locId];
                if (locRes && locRes.name) wardName = locRes.name;
              }
            }
            if (!wardName && enc.serviceProvider && enc.serviceProvider.display) {
              wardName = enc.serviceProvider.display;
            }
          }

          // 菌名
          const code = obs.code || {};
          const coding0 = (code.coding && code.coding[0]) || {};
          const organismTextSource =
            (code.text || "") +
            " " +
            (coding0.display || "") +
            " " +
            (coding0.code || "");
          const organism =
            code.text || coding0.display || coding0.code || "未標註菌名";

          if (!isObservationMatchBacteria(obs, organismTextSource, bacteriaOption)) {
            continue;
          }

          // 檢驗時間
          const effective =
            obs.effectiveDateTime ||
            (obs.effectivePeriod && obs.effectivePeriod.start) ||
            obs.issued ||
            "";
          const dateKey = effective ? String(effective).slice(0, 10) : "未知日期";

          cases.push({
            obsId: obs.id,
            patientId,
            patientRes,
            wardName: wardName || "未知地點",
            organism,
            dateKey
          });
        }

        logDebug(
          {
            caseCount: cases.length,
            patientCount: Object.keys(
              cases.reduce((m, c) => ((m[c.patientId] = true), m), {})
            ).length,
            bacteria: bacteriaOption.label
          },
          "初步病例 Case 數統計（依菌株過濾後，多病人）"
        );

        return { cases, patientsById };
      }

      /********** 從 cases 組出「只有病人節點 + 病人→病人邊」，可指定 rootPatientId **********/
      function buildGraphElementsFromCases(cases, patientsById, rootPatientId) {
        const patientInfo = {}; // patientId -> { name, maskedLabel, firstDate }
        const contactToEvents = {}; // contactKey -> [{patientId, dateKey, organism, wardName}]

        for (const c of cases) {
          const pId = c.patientId;

          // 病人資訊
          if (!patientInfo[pId]) {
            const p = patientsById[pId];
            let displayName = "";

            if (p && p.name && p.name[0]) {
              const n = p.name[0];
              const full =
                n.text ||
                `${n.family || ""}${(n.given || []).join("")}`.trim();
              displayName = full || "";
            }

            const masked = maskName(displayName) || shortId(pId) || "未知病人";
            patientInfo[pId] = {
              id: pId,
              displayName,
              masked,
              firstDate: c.dateKey || "9999-12-31"
            };
          } else {
            // 更新最早日期
            const cur = patientInfo[pId];
            if (c.dateKey && c.dateKey < cur.firstDate) {
              cur.firstDate = c.dateKey;
            }
          }

          // contactKey = 病房 + 菌名 + 日期
          const contactKey = `${c.wardName}|${c.organism}|${c.dateKey}`;
          if (!contactToEvents[contactKey]) {
            contactToEvents[contactKey] = [];
          }
          contactToEvents[contactKey].push({
            patientId: pId,
            dateKey: c.dateKey,
            organism: c.organism,
            wardName: c.wardName
          });
        }

        // 如果指定 root，但完全沒有這個病人的 MDRO 事件 → 直接回傳「找不到」
        if (rootPatientId && !patientInfo[rootPatientId]) {
          return {
            elements: [],
            patientCount: 0,
            edgeCount: 0,
            hasRoot: false
          };
        }

        // 先照原規則排順序，再把 root 排到最前面
        const patientList = Object.values(patientInfo).sort((a, b) => {
          if (rootPatientId) {
            if (a.id === rootPatientId && b.id !== rootPatientId) return -1;
            if (b.id === rootPatientId && a.id !== rootPatientId) return 1;
          }
          if (a.firstDate === b.firstDate) {
            return a.id.localeCompare(b.id);
          }
          return a.firstDate < b.firstDate ? -1 : 1;
        });

        const noMap = {}; // patientId -> No.X
        patientList.forEach((p, idx) => {
          noMap[p.id] = `No.${idx + 1}`;
        });

        // 建 adjacency（方便做 root 的連通分量）
        const adjacency = {}; // patientId -> Set<patientId>
        const ppEdges = [];
        const ppEdgeSet = new Set();

        for (const [contactKey, events] of Object.entries(contactToEvents)) {
          const patientsInContact = Array.from(
            new Set(events.map((e) => e.patientId))
          );
          if (patientsInContact.length < 2) continue;

          for (let i = 0; i < patientsInContact.length; i++) {
            for (let j = i + 1; j < patientsInContact.length; j++) {
              const a = patientsInContact[i];
              const b = patientsInContact[j];

              const pa = patientInfo[a];
              const pb = patientInfo[b];
              if (!pa || !pb) continue;

              // 方向：最早 firstDate 的當 source
              let src = pa;
              let tgt = pb;

              if (
                pb.firstDate < pa.firstDate ||
                (pb.firstDate === pa.firstDate && pb.id < pa.id)
              ) {
                src = pb;
                tgt = pa;
              }

              const edgeKey = `${src.id}|${tgt.id}`;
              if (ppEdgeSet.has(edgeKey)) continue;
              ppEdgeSet.add(edgeKey);

              ppEdges.push({
                from: "p-" + src.id,
                to: "p-" + tgt.id,
                srcPid: src.id,
                tgtPid: tgt.id
              });

              if (!adjacency[src.id]) adjacency[src.id] = new Set();
              if (!adjacency[tgt.id]) adjacency[tgt.id] = new Set();
              adjacency[src.id].add(tgt.id);
              adjacency[tgt.id].add(src.id);
            }
          }
        }

        // 如果有指定 root：只保留 root 這個 connected component
        let reachable = null;
        if (rootPatientId) {
          reachable = new Set();
          const q = [rootPatientId];
          reachable.add(rootPatientId);
          while (q.length) {
            const cur = q.shift();
            const neigh = adjacency[cur];
            if (!neigh) continue;
            for (const nb of neigh) {
              if (!reachable.has(nb)) {
                reachable.add(nb);
                q.push(nb);
              }
            }
          }
        }

        const elements = [];
        let visiblePatientCount = 0;
        let visibleEdgeCount = 0;

        // 病人節點
        patientList.forEach((p) => {
          if (reachable && !reachable.has(p.id)) return;
          visiblePatientCount++;
          elements.push({
            data: {
              id: "p-" + p.id,
              label: `${noMap[p.id]} ${p.masked}`,
              type: "patient"
            }
          });
        });

        // 人→人 邊
        ppEdges.forEach((e, idx) => {
          if (reachable) {
            if (!reachable.has(e.srcPid) || !reachable.has(e.tgtPid)) return;
          }
          visibleEdgeCount++;
          elements.push({
            data: {
              id: "pp-" + idx,
              source: e.from,
              target: e.to,
              type: "pp"
            }
          });
        });

        return {
          elements,
          patientCount: visiblePatientCount,
          edgeCount: visibleEdgeCount,
          hasRoot: !rootPatientId || !!patientInfo[rootPatientId]
        };
      }

      /********** 用 Cytoscape 畫圖（只有病人節點 + 病人→病人邊） **********/
      function renderGraph(elements, statsText) {
        const statsDiv = document.getElementById("graph-stats");
        statsDiv.textContent = statsText;

        const cy = cytoscape({
          container: document.getElementById("cy"),
          elements: elements,
          style: [
            {
              selector: "node[type = 'patient']",
              style: {
                "background-color": "#f28b82",
                "border-color": "#042433",
                "border-width": 2,
                label: "data(label)",
                "text-valign": "center",
                "text-halign": "center",
                "text-wrap": "wrap",
                "font-size": 10,
                shape: "ellipse",
                width: 50,
                height: 50
              }
            },
            {
              selector: "edge[type = 'pp']",
              style: {
                "line-style": "solid",
                "line-color": "#7a7a7a",
                "target-arrow-shape": "triangle",
                "target-arrow-color": "#7a7a7a",
                "curve-style": "straight",
                width: 2
              }
            },
            {
              selector: ":selected",
              style: {
                "border-width": 3,
                "border-color": "#ffab00",
                "line-color": "#ffab00",
                "target-arrow-color": "#ffab00"
              }
            },
            {
              selector: ".dim",
              style: {
                opacity: 0.2
              }
            }
          ],
          layout: {
            name: "cose",
            animate: false
          }
        });

        // 點病人節點時 highlight 相關人
        cy.on("tap", "node[type = 'patient']", (evt) => {
          const node = evt.target;
          cy.elements().removeClass("dim");
          const neighborhood = node.closedNeighborhood();
          cy.elements().difference(neighborhood).addClass("dim");
        });

        // 點空白還原
        cy.on("tap", (evt) => {
          if (evt.target === cy) {
            cy.elements().removeClass("dim");
          }
        });
      }

      /********** 初始化整個 App **********/
      FHIR.oauth2
        .ready()
        .then(async (client) => {
          logDebug(client.state, "SMART client.state");
          renderMeta(client);

          const reloadBtn = document.getElementById("btn-reload-graph");
          const clearBtn = document.getElementById("btn-clear-debug");
          const selOrganism = document.getElementById("sel-organism");
          const btnApplyRoot = document.getElementById("btn-apply-root");
          const txtRoot = document.getElementById("txt-root-patient");

          async function reloadGraph(rootMode) {
            const opt = getSelectedBacteriaOption();
            const rootIdInput = txtRoot.value.trim();
            const rootPatientId = rootMode && rootIdInput ? rootIdInput : null;

            reloadBtn.disabled = true;
            btnApplyRoot.disabled = true;

            const rootMsg = rootPatientId
              ? `起始病人：Patient/${rootPatientId}；`
              : "";
            document.getElementById("graph-stats").textContent =
              `${rootMsg}從 FHIR 讀取資料並重建「人→人」傳播鏈中...（菌種：${opt.label}）`;

            try {
              const { cases, patientsById } = await buildTransmissionData(
                client,
                opt
              );

              if (!cases.length) {
                renderGraph(
                  [],
                  `查無符合條件的抗藥菌 Observation（菌種：${opt.label}），無法建立人→人傳播鏈。`
                );
                return;
              }

              const {
                elements,
                patientCount,
                edgeCount,
                hasRoot
              } = buildGraphElementsFromCases(cases, patientsById, rootPatientId);

              if (rootPatientId && !hasRoot) {
                renderGraph(
                  [],
                  `在本次查詢的抗藥菌 Observation 中找不到 Patient/${rootPatientId} 的事件，請確認 ID 或測試資料。`
                );
                return;
              }

              if (!elements.length || patientCount === 0) {
                renderGraph(
                  [],
                  `已有抗藥菌 Observation，但無法形成兩人以上的傳播關係（菌種：${opt.label}）。`
                );
                return;
              }

              const statsText =
                (rootPatientId
                  ? `起始病人：Patient/${rootPatientId}。`
                  : "") +
                `節點：病人 ${patientCount} 人；邊：病人-病人 ${edgeCount} 條。（菌種：${opt.label}）`;

              renderGraph(elements, statsText);
            } catch (err) {
              console.error(err);
              logDebug(err, "建立傳播鏈失敗");
              document.getElementById("graph-stats").innerHTML =
                '<span class="error">無法從 FHIR 建立人→人傳播鏈，請查看下方 Debug 訊息。</span>';
              renderGraph([], "建立傳播鏈失敗。");
            } finally {
              reloadBtn.disabled = false;
              btnApplyRoot.disabled = false;
            }
          }

          // 初次載入：不指定起點
          await reloadGraph(false);

          // 綁定事件
          reloadBtn.addEventListener("click", () => reloadGraph(false));
          btnApplyRoot.addEventListener("click", () => reloadGraph(true));
          selOrganism.addEventListener("change", () => reloadGraph(!!txtRoot.value.trim()));
          clearBtn.addEventListener("click", () => {
            document.getElementById("debug-log").textContent =
              "// 已清除訊息，可重新操作。";
          });
        })
        .catch((err) => {
          console.error("SMART 初始化失敗", err);
          logDebug(err, "SMART 初始化失敗");
          document.getElementById("meta-content").innerHTML =
            '<span class="error">SMART 初始化失敗，請確認 launch.html 設定與沙盒環境。</span>';
          document.getElementById("graph-stats").textContent =
            "無法載入 FHIR 資料。";
        });
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ—æ…ˆæ¿Ÿ-æŠ—è—¥èŒåœ°åœ– (å®Œæ•´è¦å‰‡ç‰ˆ)</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #2c3e50; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #cy { width: 100%; height: 650px; border: 1px solid #ddd; background: #fff; border-radius: 4px; }
        button { background: #1976d2; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; }
        button:disabled { background: #cfd8dc; color: #90a4ae; cursor: not-allowed; }
        select, input { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 1rem; }
        .legend { margin-top: 10px; padding: 10px; background: #f9f9f9; border-radius: 4px; font-size: 0.9rem; line-height: 1.8; }
        .dot { display: inline-block; width: 12px; height: 12px; margin-right: 5px; vertical-align: middle; border: 1px solid #042433; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æŠ—è—¥èŒåœ°åœ–å‚³æ’­éˆ</h1>
        
        <div class="controls">
            <label>ç—…äºº IDï¼š</label>
            <input type="text" id="root-id" placeholder="è¼¸å…¥ ID (ä¾‹å¦‚: 670653)" style="width: 150px;">
            
            <label>ç›®æ¨™èŒç¨®ï¼š</label>
            <select id="organism">
                <option value="ALL">å…¨éƒ¨ (All)</option>
                <option value="MRSA">Staphylococcus aureus (MRSA)</option>
                <option value="CRAB">Acinetobacter baumannii (CRAB)</option>
                <option value="VRE">Enterococcus faecium (VRE)</option>
                <option value="CRPA">Pseudomonas aeruginosa (CRPA)</option>
                <option value="CRE_COLI">E.coli (CR)</option>
                <option value="CRKP">Klebsiella pneumoniae (CR)</option>
            </select>

            <button id="btn-draw" onclick="runAnalysis()">ğŸš€ é–‹å§‹åˆ†æ</button>
            <span id="status" style="color: #d32f2f; font-weight: bold; margin-left: 10px;"></span>
        </div>

        <div id="cy"></div>
        
        <div class="legend">
            <b>åœ–ä¾‹èªªæ˜ï¼š</b><br>
            <span class="dot" style="background:#F28B82; border-radius:50%;"></span><b>åœ“å½¢ (ç´…è‰²)</b>ï¼šæ„ŸæŸ“è€… (Infected) - ä¾æª¢é©—æ™‚é–“æ¨™è¨˜ No.1, No.2<br>
            <span class="dot" style="background:#AECBFA;"></span><b>æ­£æ–¹å½¢ (è—è‰²)</b>ï¼šæ¥è§¸è€… (å«åŒç—…æˆ¿ç—…äººã€é†«æŠ€ã€è¡Œæ”¿äººå“¡)<br>
            <b>â¡ å¯¦ç·šç®­é ­</b>ï¼šæ„ŸæŸ“å‚³æ’­ (å…ˆ â†’ å¾Œ)<br>
            <b>--- è™›ç·š</b>ï¼šæ¥è§¸é—œè¯
        </div>
    </div>

    <script>
        let fhirClient = null;
        let cy = null;

        FHIR.oauth2.ready().then(c => { 
            fhirClient = c; 
            if(c.patient.id) document.getElementById("root-id").value = c.patient.id; 
        });

        const BUG_KEYWORDS = {
            "MRSA": ["mrsa", "staphylococcus aureus"],
            "CRAB": ["crab", "acinetobacter", "baumannii"],
            "VRE": ["vre", "enterococcus", "faecium"],
            "CRPA": ["crpa", "pseudomonas", "aeruginosa"],
            "CRE_COLI": ["e.coli", "escherichia", "carbapenem"],
            "CRKP": ["klebsiella", "pneumoniae", "carbapenem"]
        };

        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgSelect = document.getElementById("organism").value;
            const btn = document.getElementById("btn-draw");
            const status = document.getElementById("status");

            if (!rootId) { alert("è«‹è¼¸å…¥ç—…äºº ID"); return; }
            btn.disabled = true;
            status.textContent = "ğŸ” 1/3 åˆ†æç—…æˆ¿èˆ‡ä½é™¢æ™‚é–“...";

            try {
                // 1. æŸ¥è©¢æ ¸å¿ƒç—…äºº (Location)
                const encQuery = `Encounter?subject=${rootId}&_include=Encounter:location`;
                const encBundle = await fhirClient.request(encQuery, { flat: false });
                
                let targetLocId = null;
                if(encBundle.entry) {
                    const enc = encBundle.entry.find(e => e.resource.resourceType === "Encounter");
                    if(enc && enc.resource.location && enc.resource.location.length > 0) {
                        targetLocId = enc.resource.location[0].location.reference.split("/").pop();
                    }
                }

                if (!targetLocId) throw new Error("æ‰¾ä¸åˆ°æ­¤ç—…äººçš„ä½é™¢ç—…æˆ¿è³‡è¨Š");

                // 2. æŠ“å–ç—…æˆ¿è³‡æ–™ (åŒ…å«ç—…äººèˆ‡é†«è­·äººå“¡)
                status.textContent = "ğŸ” 2/3 æƒææ¥è§¸è€… (å«é†«è­·äººå“¡)...";
                const query = `Encounter?location=${targetLocId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=300`;
                const bundle = await fhirClient.request(query, { flat: false });

                // 3. è³‡æ–™è§£æ
                status.textContent = "ğŸ” 3/3 è¨ˆç®—å‚³æ’­è·¯å¾‘èˆ‡æ’åº...";
                
                const nodesMap = {}; // å„²å­˜æ‰€æœ‰äºº (ç—…äºº + é†«è­·)
                const patientEncounters = {}; // å„²å­˜ç—…äººçš„ Encounter è³‡è¨Š

                if (bundle.entry) {
                    // Step A: å»ºç«‹ç—…äººåå–®
                    bundle.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Patient") {
                            const name = r.name?.[0]?.text || "Unknown";
                            if(!nodesMap[r.id]) {
                                nodesMap[r.id] = { 
                                    id: r.id, 
                                    name: name, 
                                    type: 'contact', // é è¨­ç‚ºæ¥è§¸è€…(æ–¹å½¢)
                                    category: 'patient',
                                    obsDate: null, 
                                    period: { start: null, end: null },
                                    rank: null
                                };
                            }
                        }
                    });

                    // Step B: è™•ç† Encounter (æ™‚é–“ + é†«è­·äººå“¡)
                    bundle.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Encounter") {
                            const patId = r.subject?.reference?.split("/").pop();
                            
                            // 1. è¨˜éŒ„ç—…äººä½é™¢æ™‚é–“
                            if (nodesMap[patId] && r.period) {
                                nodesMap[patId].period = {
                                    start: new Date(r.period.start).getTime(),
                                    end: r.period.end ? new Date(r.period.end).getTime() : 9999999999999
                                };
                                patientEncounters[patId] = r; // æš«å­˜ Encounter ä¾›å¾ŒçºŒæŠ“é†«è­·ç”¨
                            }

                            // 2. â˜…â˜…â˜… æ–°å¢è¦å‰‡ï¼šæŠ“å–åƒèˆ‡çš„é†«è­·/è¡Œæ”¿äººå“¡ (Participant) â˜…â˜…â˜…
                            if (r.participant) {
                                r.participant.forEach(part => {
                                    if (part.individual && part.individual.reference) {
                                        // é†«è­·äººå“¡ ID (ä¾‹å¦‚ Practitioner/123 -> 123)
                                        // ç‚ºäº†é¿å…è·Ÿç—…äºº ID è¡çªï¼Œé€™é‚ŠåŠ å€‹å‰ç¶´
                                        const rawStaffId = part.individual.reference.split("/").pop();
                                        const staffId = "staff-" + rawStaffId; 
                                        const staffName = part.individual.display || "é†«è­·äººå“¡";

                                        if (!nodesMap[staffId]) {
                                            nodesMap[staffId] = {
                                                id: staffId,
                                                name: staffName,
                                                type: 'contact', // é†«è­·äººå“¡å¿…å®šæ˜¯æ¥è§¸è€…(æ–¹å½¢)
                                                category: 'staff',
                                                period: { start: null, end: null } // é†«è­·äººå“¡ä¸ç‰¹åˆ¥æ¯”å°æ™‚é–“ï¼Œè¦–ç‚ºè©²æ¬¡ä½é™¢å¿…å®šæ¥è§¸
                                            };
                                        }
                                    }
                                });
                            }
                        }
                    });

                    // Step C: æ¨™è¨˜æ„ŸæŸ“ (Observation)
                    bundle.entry.forEach(e => {
                        const r = e.resource;
                        if (r.resourceType === "Observation") {
                            const raw = JSON.stringify(r).toLowerCase();
                            let isTarget = false;
                            if (orgSelect === "ALL") isTarget = true;
                            else {
                                const keywords = BUG_KEYWORDS[orgSelect];
                                if (keywords && keywords.every(k => raw.includes(k))) isTarget = true;
                            }

                            if (isTarget) {
                                const patId = r.subject?.reference?.split("/").pop();
                                if (nodesMap[patId]) {
                                    nodesMap[patId].type = 'infected'; // è®Šç‚ºåœ“å½¢
                                    const d = r.effectiveDateTime ? r.effectiveDateTime.substring(0, 10) : "9999";
                                    if (!nodesMap[patId].obsDate || d < nodesMap[patId].obsDate) {
                                        nodesMap[patId].obsDate = d;
                                    }
                                }
                            }
                        }
                    });
                }

                // Step D: â˜…â˜…â˜… æ’åºä¸¦æ¨™è¨˜ No.1, No.2... â˜…â˜…â˜…
                const infectedList = Object.values(nodesMap)
                    .filter(n => n.type === 'infected')
                    .sort((a, b) => {
                        if (a.obsDate < b.obsDate) return -1;
                        if (a.obsDate > b.obsDate) return 1;
                        return 0;
                    });
                
                infectedList.forEach((node, index) => {
                    node.rank = index + 1; // è³¦äºˆæ’å
                });

                // 4. å»ºç«‹é€£ç·šé‚è¼¯
                const edges = [];
                const activeNodes = new Set(); // è¨˜éŒ„è¦é¡¯ç¤ºçš„äºº
                const nodeList = Object.values(nodesMap);

                // åˆ†é›¢ç—…äººèˆ‡é†«è­·
                const patList = nodeList.filter(n => n.category === 'patient' && n.period.start);
                
                for (let i = 0; i < patList.length; i++) {
                    const p1 = patList[i];

                    // 4-1. ç—…äºº vs ç—…äºº (æ™‚é–“é‡ç–Š)
                    for (let j = i + 1; j < patList.length; j++) {
                        const p2 = patList[j];
                        
                        const isOverlap = (p1.period.start <= p2.period.end) && (p1.period.end >= p2.period.start);
                        if (!isOverlap) continue;

                        // ç´… <-> ç´… (å¯¦ç·šç®­é ­)
                        if (p1.type === 'infected' && p2.type === 'infected') {
                            if (p1.obsDate < p2.obsDate) edges.push({ data: { source: p1.id, target: p2.id, type: 'transmit' } });
                            else if (p2.obsDate < p1.obsDate) edges.push({ data: { source: p2.id, target: p1.id, type: 'transmit' } });
                            else edges.push({ data: { source: p1.id, target: p2.id, type: 'concurrent' } });
                            activeNodes.add(p1.id); activeNodes.add(p2.id);
                        }
                        // ç´… <-> è— (è™›ç·š)
                        else if (p1.type === 'infected' && p2.type === 'contact') {
                            edges.push({ data: { source: p1.id, target: p2.id, type: 'contact' } });
                            activeNodes.add(p1.id); activeNodes.add(p2.id);
                        }
                        else if (p2.type === 'infected' && p1.type === 'contact') {
                            edges.push({ data: { source: p2.id, target: p1.id, type: 'contact' } });
                            activeNodes.add(p1.id); activeNodes.add(p2.id);
                        }
                    }

                    // 4-2. â˜…â˜…â˜… ç—…äºº vs é†«è­·äººå“¡ (ç›´æ¥é€£ç·š) â˜…â˜…â˜…
                    // åªè¦è©²ç—…äººæ˜¯æ„ŸæŸ“è€…ï¼Œä¸”è©²æ¬¡ä½é™¢æœ‰é€™å€‹é†«è­·äººå“¡åƒèˆ‡ï¼Œå°±é€£ç·š
                    if (p1.type === 'infected') {
                        const enc = patientEncounters[p1.id];
                        if (enc && enc.participant) {
                            enc.participant.forEach(part => {
                                if (part.individual && part.individual.reference) {
                                    const rawId = part.individual.reference.split("/").pop();
                                    const staffId = "staff-" + rawId;
                                    if (nodesMap[staffId]) {
                                        // å»ºç«‹ ç´…(ç—…äºº) -> è—(é†«è­·) çš„è™›ç·š
                                        edges.push({ data: { source: p1.id, target: staffId, type: 'contact' } });
                                        activeNodes.add(p1.id); 
                                        activeNodes.add(staffId);
                                    }
                                }
                            });
                        }
                    }
                }

                // 5. æœ€çµ‚éæ¿¾èˆ‡æ ¼å¼åŒ–
                const finalNodes = nodeList
                    .filter(n => n.type === 'infected' || activeNodes.has(n.id))
                    .map(n => {
                        // æ¨™ç±¤é¡¯ç¤ºé‚è¼¯
                        let labelText = n.name;
                        if (n.type === 'infected') {
                            labelText = `No.${n.rank} ${n.name}\n${n.obsDate}`;
                        }
                        return {
                            data: {
                                id: n.id,
                                label: labelText,
                                type: n.type,
                                isRoot: n.id === rootId
                            }
                        };
                    });

                status.textContent = `é¡¯ç¤ºï¼š${finalNodes.length} å€‹ç¯€é»`;
                renderGraph(finalNodes, edges);

            } catch (err) {
                console.error(err);
                status.textContent = "éŒ¯èª¤: " + err.message;
            } finally {
                btn.disabled = false;
            }
        }

        function renderGraph(nodes, edges) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes, edges },
                style: [
                    {
                        selector: 'node',
                        style: {
                            'label': 'data(label)',
                            'text-wrap': 'wrap',
                            'text-valign': 'center',
                            'text-halign': 'center',
                            'font-size': '12px',
                            'font-weight': 'bold',
                            'color': '#000000', // å­—é«”å…¨é»‘
                            'border-width': 2,
                            'border-color': '#042433' // çµ±ä¸€é‚Šæ¡†è‰²
                        }
                    },
                    {
                        selector: 'node[type="infected"]',
                        style: { 'shape': 'ellipse', 'background-color': '#F28B82', 'width': 90, 'height': 90 } // ç´…è‰²åœ“å½¢
                    },
                    {
                        selector: 'node[type="contact"]',
                        style: { 'shape': 'rectangle', 'background-color': '#AECBFA', 'width': 80, 'height': 80 } // è—è‰²æ–¹å½¢
                    },
                    {
                        selector: 'node[?isRoot]',
                        style: { 'border-width': 5, 'border-color': '#f1c40f' } // æ ¸å¿ƒç—…äººé«˜äº®
                    },
                    {
                        selector: 'edge[type="transmit"]',
                        style: { 'width': 4, 'line-color': '#F28B82', 'target-arrow-color': '#F28B82', 'target-arrow-shape': 'triangle', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="contact"]',
                        style: { 'width': 2, 'line-color': '#95a5a6', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    {
                        selector: 'edge[type="concurrent"]',
                        style: { 'width': 4, 'line-color': '#F28B82', 'line-style': 'dashed', 'curve-style': 'bezier' }
                    },
                    {
                        selector: '.highlight',
                        style: { 'border-width': 4, 'border-color': '#000', 'z-index': 999 }
                    },
                    {
                        selector: '.faded',
                        style: { 'opacity': 0.1 }
                    }
                ],
                layout: { name: 'cose', animate: true, padding: 50, componentSpacing: 80 }
            });

            cy.on('tap', function(e) {
                if(e.target === cy){
                    cy.elements().removeClass('faded highlight');
                } else {
                    const node = e.target;
                    cy.elements().addClass('faded');
                    const neighborhood = node.neighborhood().add(node);
                    neighborhood.removeClass('faded').addClass('highlight');
                }
            });
        }
    </script>
</body>
</html>
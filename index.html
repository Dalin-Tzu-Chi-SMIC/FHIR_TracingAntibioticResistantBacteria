<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ—è—¥èŒåœ°åœ–</title>
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", sans-serif; background: #f4f6f8; padding: 20px; }
        .container { max-width: 1280px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .controls { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; align-items: center; }
        #cy { width: 100%; height: 650px; border: 1px solid #ddd; background: #fff; }
        #console-log { background: #333; color: #0f0; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 12px; margin-top: 10px; border-radius: 4px; }
        .legend { margin-top: 10px; font-size: 0.9rem; }
        .dot { display: inline-block; width: 12px; height: 12px; margin-right: 5px; vertical-align: middle; border: 1px solid #000; }
    </style>
</head>
<body>
    <div class="container">
        <h2>æŠ—è—¥èŒåœ°åœ–</h2>
        <div class="controls">
            <label>ç—…äºº IDï¼š</label>
            <input type="text" id="root-id" placeholder="æ¸¬è©¦ID:670667" value="670667">
            <label>èŒç¨®ï¼š</label>
            <select id="organism">
                <option value="MRSA">MRSA</option>
                <option value="CRAB">CRAB</option>
                <option value="ALL">ALL</option>
            </select>
            <button onclick="runAnalysis()">ğŸš€ é–‹å§‹åˆ†æ</button>
        </div>
        <div id="cy"></div>
        <div id="console-log">ç­‰å¾…åŸ·è¡Œ...</div>
    </div>

    <script>
        let fhirClient = null;
        let cy = null;

        function log(msg) {
            const d = document.getElementById("console-log");
            d.innerHTML += `<div>> ${msg}</div>`;
            d.scrollTop = d.scrollHeight;
            console.log(`[APP] ${msg}`);
        }

        FHIR.oauth2.ready().then(c => { fhirClient = c; log("FHIR Client Ready"); });

        const BUG_KEYWORDS = {
            "MRSA": ["mrsa", "staphylococcus aureus"],
            "CRAB": ["crab", "acinetobacter", "baumannii"],
            "ALL": [""]
        };

        async function runAnalysis() {
            const rootId = document.getElementById("root-id").value.trim();
            const orgSelect = document.getElementById("organism").value;
            
            document.getElementById("console-log").innerHTML = ""; // Clear log
            log(`é–‹å§‹åˆ†æ ç—…äºº:${rootId}, èŒç¨®:${orgSelect}`);

            try {
                // 1. æ‰¾ Location
                const encQuery = `Encounter?subject=${rootId}&_include=Encounter:location&_sort=-date`;
                const encBundle = await fhirClient.request(encQuery, { flat: false });
                
                let targetLocId = null;
                if(encBundle.entry) {
                    const enc = encBundle.entry.find(e => e.resource.resourceType === "Encounter");
                    if(enc && enc.resource.location) {
                        targetLocId = enc.resource.location[0].location.reference.split("/").pop();
                    }
                }
                
                if(!targetLocId) { log("âŒ æ‰¾ä¸åˆ°è©²ç—…äººçš„ä½é™¢ç—…æˆ¿ Location"); return; }
                log(`âœ… é–å®šç—…æˆ¿ ID: ${targetLocId}`);

                // 2. æŠ“å…¨ç—…æˆ¿è³‡æ–™
                const query = `Encounter?location=${targetLocId}&_include=Encounter:subject&_revinclude=Observation:encounter&_count=500`;
                const bundle = await fhirClient.request(query, { flat: false });
                
                if(!bundle.entry) { log("âŒ è©²ç—…æˆ¿æ²’æœ‰ä»»ä½•è³‡æ–™"); return; }
                log(`ğŸ“¦ ä¸‹è¼‰è³‡æ–™æˆåŠŸ: å…± ${bundle.entry.length} ç­†`);

                // 3. å»ºç«‹ç´¢å¼•
                const nodesMap = {};
                const patientEncounters = {}; 
                const infectedEncounters = new Set(); // å­˜ "Encounter ID" (ç„¡å‰ç¶´)

                // A. è™•ç† Patient & Encounter
                bundle.entry.forEach(e => {
                    const r = e.resource;
                    if(r.resourceType === "Patient") {
                        const name = r.name?.[0]?.text || "Unknown";
                        if(!nodesMap[r.id]) {
                            nodesMap[r.id] = { id: r.id, name: name, type: 'contact', category: 'patient', obsDate: null, rank: null };
                        }
                    }
                    if(r.resourceType === "Encounter") {
                        const patId = r.subject?.reference?.split("/").pop();
                        if(!patientEncounters[patId]) patientEncounters[patId] = [];
                        patientEncounters[patId].push(r);
                        
                        // Debug: æª¢æŸ¥é€™ç­† Encounter æœ‰æ²’æœ‰åƒèˆ‡è€…
                        if(r.participant && r.participant.length > 0) {
                            log(`ğŸ” ç™¼ç¾é†«è­·äººå“¡è³‡æ–™! Encounter ID: ${r.id}, äººæ•¸: ${r.participant.length}`);
                        }
                    }
                });

                // B. è™•ç† Observation (æ¨™è¨˜æ„ŸæŸ“ + é–å®šäº‹ä»¶)
                bundle.entry.forEach(e => {
                    const r = e.resource;
                    if(r.resourceType === "Observation") {
                        const raw = JSON.stringify(r).toLowerCase();
                        const keywords = BUG_KEYWORDS[orgSelect];
                        const isTarget = orgSelect === "ALL" ? true : keywords.every(k => raw.includes(k));

                        if(isTarget) {
                            const patId = r.subject?.reference?.split("/").pop();
                            
                            // æ¨™è¨˜äºº
                            if(nodesMap[patId]) {
                                nodesMap[patId].type = 'infected';
                                const d = r.effectiveDateTime ? r.effectiveDateTime.substring(0, 10) : "9999";
                                if(!nodesMap[patId].obsDate || d < nodesMap[patId].obsDate) nodesMap[patId].obsDate = d;
                            }

                            // æ¨™è¨˜äº‹ä»¶ (é—œéµä¿®æ­£ï¼šå»å‰ç¶´)
                            if(r.encounter && r.encounter.reference) {
                                const encId = r.encounter.reference.split("/").pop(); // â˜…â˜…â˜… é€™è£¡ä¸€å®šè¦ split
                                infectedEncounters.add(encId);
                                log(`ğŸ¦  é–å®šæ„ŸæŸ“äº‹ä»¶ (Infected Encounter): ${encId}`);
                            }
                        }
                    }
                });

                // 4. é€£ç·šé‚è¼¯
                const edges = [];
                const activeNodes = new Set();

                log(`é–‹å§‹æƒæ ${infectedEncounters.size} å€‹æ„ŸæŸ“äº‹ä»¶...`);

                infectedEncounters.forEach(targetEncId => {
                    // éæ­·æ‰€æœ‰ Encounter æ‰¾åˆ°é€™å€‹ ID
                    Object.values(patientEncounters).flat().forEach(idxEnc => {
                        // â˜…â˜…â˜… é—œéµä¿®æ­£ï¼šID æ¯”å° â˜…â˜…â˜…
                        if (idxEnc.id !== targetEncId) return; 

                        const p1Id = idxEnc.subject?.reference?.split("/").pop();
                        activeNodes.add(p1Id);

                        // 4-1. æŠ“é†«è­·äººå“¡ (Staff)
                        if (idxEnc.participant) {
                            idxEnc.participant.forEach(part => {
                                if (part.individual && part.individual.reference) {
                                    const rawStaffId = part.individual.reference.split("/").pop();
                                    const staffId = "staff-" + rawStaffId;
                                    const staffName = part.individual.display || "é†«è­·äººå“¡";

                                    // å»ºç«‹ç¯€é»
                                    if (!nodesMap[staffId]) {
                                        nodesMap[staffId] = { id: staffId, name: staffName, type: 'contact', category: 'staff' };
                                    }
                                    
                                    // å»ºç«‹é€£ç·š
                                    edges.push({ data: { source: p1Id, target: staffId, type: 'contact' } });
                                    activeNodes.add(staffId);
                                    log(`ğŸ”— [æ¥è§¸] ç—…äºº ${nodesMap[p1Id].name} -> é†«è­· ${staffName}`);
                                }
                            });
                        }

                        // 4-2. æŠ“å®¤å‹ (ç°¡ç•¥ç‰ˆ: åªè¦æœ‰é‡ç–Šå°±ç®—)
                        if(idxEnc.period) {
                            const start = new Date(idxEnc.period.start).getTime();
                            const end = idxEnc.period.end ? new Date(idxEnc.period.end).getTime() : 9999999999999;
                            
                            Object.values(patientEncounters).flat().forEach(otherEnc => {
                                if(otherEnc.id === idxEnc.id) return; // ç•¥éè‡ªå·±
                                
                                const p2Id = otherEnc.subject?.reference?.split("/").pop();
                                if(!nodesMap[p2Id]) return;

                                const oStart = new Date(otherEnc.period.start).getTime();
                                const oEnd = otherEnc.period.end ? new Date(otherEnc.period.end).getTime() : 9999999999999;
                                
                                if (start <= oEnd && end >= oStart) {
                                    if(nodesMap[p2Id].type === 'infected') {
                                        // æ„ŸæŸ“è€…äº’é€£
                                        edges.push({ data: { source: p1Id, target: p2Id, type: 'transmit' } }); // ç°¡åŒ–ï¼šé›™å‘
                                        activeNodes.add(p2Id);
                                    } else {
                                        // æ„ŸæŸ“è€… -> å®¤å‹
                                        edges.push({ data: { source: p1Id, target: p2Id, type: 'contact' } });
                                        activeNodes.add(p2Id);
                                    }
                                }
                            });
                        }
                    });
                });

                // 5. ç¹ªåœ–
                const finalNodes = Object.values(nodesMap)
                    .filter(n => activeNodes.has(n.id))
                    .map(n => ({
                        data: {
                            id: n.id,
                            label: n.name,
                            type: n.type,
                            isRoot: n.id === rootId
                        }
                    }));

                log(`âœ… æœ€çµ‚ç¹ªè£½: ${finalNodes.length} å€‹ç¯€é», ${edges.length} æ¢é€£ç·š`);
                renderGraph(finalNodes, edges);

            } catch (err) {
                console.error(err);
                log(`âŒ éŒ¯èª¤: ${err.message}`);
            }
        }

        function renderGraph(nodes, edges) {
            cy = cytoscape({
                container: document.getElementById('cy'),
                elements: { nodes, edges },
                style: [
                    { selector: 'node', style: { 'label': 'data(label)', 'text-wrap': 'wrap', 'text-valign': 'center', 'text-halign': 'center', 'color': '#000', 'border-width': 2, 'border-color': '#042433' } },
                    { selector: 'node[type="infected"]', style: { 'shape': 'ellipse', 'background-color': '#F28B82', 'width': 80, 'height': 80 } },
                    { selector: 'node[type="contact"]', style: { 'shape': 'rectangle', 'background-color': '#AECBFA', 'width': 70, 'height': 70 } },
                    { selector: 'edge', style: { 'width': 3, 'line-color': '#999', 'curve-style': 'bezier' } }
                ],
                layout: { name: 'cose', animate: true }
            });
        }
    </script>
</body>
</html>
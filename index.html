<!DOCTYPE html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>ç–«èª¿å‚³æ’­éˆ SMART App (FHIR Sandbox)</title>

    <!-- SMART on FHIR JS å®¢æˆ¶ç«¯ -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

    <!-- Cytoscape.jsï¼šç”¨ä¾†ç•«é—œä¿‚åœ– -->
    <script src="https://unpkg.com/cytoscape@3.29.2/dist/cytoscape.min.js"></script>

    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Microsoft JhengHei",
          sans-serif;
        margin: 0;
        padding: 0;
        background: #f5f5f7;
      }

      header {
        background: #003366;
        color: #fff;
        padding: 1rem 1.5rem;
      }

      header h1 {
        margin: 0;
        font-size: 1.4rem;
      }

      header small {
        display: block;
        font-size: 0.8rem;
        opacity: 0.8;
      }

      main {
        padding: 1rem 1.5rem 2rem 1.5rem;
        max-width: 1200px;
        margin: 0 auto;
      }

      .card {
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        padding: 1rem 1.2rem;
        margin-bottom: 1rem;
      }

      .card h2 {
        margin-top: 0;
        font-size: 1.1rem;
        border-bottom: 1px solid #e0e0e0;
        padding-bottom: 0.3rem;
        margin-bottom: 0.5rem;
      }

      .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.8rem 2rem;
        font-size: 0.9rem;
      }

      .meta-label {
        font-weight: 600;
      }

      #cy {
        width: 100%;
        height: 500px;
        border-radius: 6px;
        border: 1px solid #ddd;
      }

      .stats {
        font-size: 0.85rem;
        color: #555;
        margin-bottom: 0.5rem;
      }

      button {
        padding: 0.35rem 0.8rem;
        border-radius: 999px;
        border: none;
        background: #003366;
        color: #fff;
        cursor: pointer;
        font-size: 0.85rem;
      }

      button:hover {
        background: #004a99;
      }

      button:disabled {
        background: #9e9e9e;
        cursor: not-allowed;
      }

      select,
      input[type="text"] {
        padding: 0.25rem 0.4rem;
        border-radius: 999px;
        border: 1px solid #ccc;
        font-size: 0.85rem;
      }

      .error {
        color: #b00020;
        font-weight: 600;
      }

      pre {
        background: #111827;
        color: #e5e7eb;
        padding: 0.7rem;
        border-radius: 6px;
        font-size: 0.8rem;
        overflow: auto;
        max-height: 260px;
      }

      @media (max-width: 768px) {
        main {
          padding: 0.8rem;
        }
        #cy {
          height: 420px;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>ç–«èª¿å‚³æ’­éˆ SMART App</h1>
      <small>å¾ FHIR(Observation / Encounter) çµ„å‡ºå‚³æ’­éˆé—œä¿‚åœ–</small>
    </header>

    <main>
      <!-- FHIR é€£ç·šè³‡è¨Š -->
      <section class="card">
        <h2>FHIR é€£ç·šè³‡è¨Š</h2>
        <div id="meta-content" class="meta-row">
          <span>åˆå§‹åŒ–ä¸­...</span>
        </div>
      </section>

      <!-- å‚³æ’­éˆåœ– -->
      <section class="card">
        <h2>å‚³æ’­éˆé—œä¿‚åœ–ï¼ˆç—…äºº â†” å…±åŒæ¥è§¸é»ï¼‰</h2>

        <div class="stats" id="graph-stats">å°šæœªè¼‰å…¥ FHIR è³‡æ–™</div>

        <div
          style="
            margin-bottom: 0.5rem;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
          "
        >
          <label for="sel-organism" style="font-size: 0.85rem;">é¸æ“‡æŠ—è—¥èŒæ ªï¼š</label>
          <select id="sel-organism">
            <option value="ALL">å…¨éƒ¨èŒç¨®ï¼ˆä¸éæ¿¾ï¼‰</option>
            <option value="CRAB">Acinetobacter baumannii(CRAB)</option>
            <option value="E_COLI_CR">E.coli (CR)</option>
            <option value="VRE">Enterococcus faecium(VRE)</option>
            <option value="KP_CR">Klebsiella pneumoniae (CR)</option>
            <option value="CRPA">Pseudomonas aeruginosa(CRPA)</option>
            <option value="MRSA">Staphylococcus aureus(MRSA)</option>
          </select>

          <label for="txt-patient-id" style="font-size: 0.85rem;">æŒ‡å®šç—…äºº Patient IDï¼š</label>
          <input
            id="txt-patient-id"
            type="text"
            placeholder="ä¾‹å¦‚ 130206ï¼ˆç•™ç™½ = å¤šç—…äººæ¨¡å¼ï¼‰"
            style="max-width: 230px;"
          />

          <button id="btn-reload-graph">é‡æ–°å¾ FHIR é‡å»ºå‚³æ’­éˆåœ–</button>
          <span style="font-size: 0.8rem; color: #555;">
            é‚è¼¯ï¼šä¾é¸å®šèŒç¨®ç¯©é¸ Observationï¼Œå†ç”¨ã€ŒèŒç¨® + Encounter åœ°é» + æ—¥æœŸã€ç”¢ç”Ÿæ¥è§¸é»ï¼Œå°‡å…±ç”¨æ¥è§¸é»çš„ç—…äººé€£æˆéˆã€‚ï¼ˆç›®å‰æœ€å¤šæŠ“å‰ 20 ç­†ï¼‰
          </span>
        </div>

        <div id="cy"></div>
      </section>

      <!-- é™¤éŒ¯ / JSON -->
      <section class="card">
        <h2>é™¤éŒ¯è¨Šæ¯ / åŸå§‹ JSON</h2>
        <button id="btn-clear-debug">æ¸…é™¤è¨Šæ¯</button>
        <pre id="debug-log">// é€™è£¡æœƒé¡¯ç¤º client ç‹€æ…‹ã€éŒ¯èª¤è¨Šæ¯èˆ‡éƒ¨åˆ†åŸå§‹ JSON</pre>
      </section>
    </main>

    <script>
      /********** æŠ—è—¥èŒæ ªé¸é …è¨­å®š **********/
      const BACTERIA_OPTIONS = [
        {
          id: "ALL",
          label: "å…¨éƒ¨èŒç¨®ï¼ˆä¸éæ¿¾ï¼‰",
          keywords: [],
        },
        {
          id: "CRAB",
          label: "Acinetobacter baumannii(CRAB)",
          keywords: ["acinetobacter baumannii", "crab"],
        },
        {
          id: "E_COLI_CR",
          label: "E.coli (CR)",
          keywords: ["e.coli", "escherichia coli", "cr e.coli"],
        },
        {
          id: "VRE",
          label: "Enterococcus faecium(VRE)",
          keywords: ["enterococcus faecium", "vre"],
        },
        {
          id: "KP_CR",
          label: "Klebsiella pneumoniae (CR)",
          keywords: ["klebsiella pneumoniae", "cr kp", "cr klebsiella"],
        },
        {
          id: "CRPA",
          label: "Pseudomonas aeruginosa(CRPA)",
          keywords: ["pseudomonas aeruginosa", "crpa"],
        },
        {
          id: "MRSA",
          label: "Staphylococcus aureus(MRSA)",
          keywords: ["staphylococcus aureus", "mrsa"],
        },
      ];

      function getSelectedBacteriaOption() {
        const sel = document.getElementById("sel-organism");
        const val = sel.value || "ALL";
        return BACTERIA_OPTIONS.find((x) => x.id === val) || BACTERIA_OPTIONS[0];
      }

      /********** å°å·¥å…·ï¼šDebug Log **********/
      function logDebug(obj, title) {
        const pre = document.getElementById("debug-log");
        const now = new Date().toISOString();
        let text = pre.textContent || "";
        text += `\n\n[${now}] ${title || "è¨Šæ¯"}\n`;
        try {
          text += typeof obj === "string" ? obj : JSON.stringify(obj, null, 2);
        } catch {
          text += String(obj);
        }
        pre.textContent = text;
      }

      /********** å°å·¥å…·ï¼šMask ç—…äººåç¨± / ID **********/
      function maskName(name) {
        if (!name) return "";
        const s = name.trim();
        if (s.length === 1) return s + "â—‹";
        if (s.length === 2) return s[0] + "â—‹";
        return s[0] + "â—‹" + s.slice(2);
      }

      function shortId(id) {
        if (!id) return "";
        const s = String(id);
        if (s.length <= 4) return s;
        return s.slice(0, 2) + "â€¦" + s.slice(-2);
      }

      /********** åˆ¤æ–·ï¼šObservation æ˜¯å¦èˆ‡ã€ŒæŠ—è—¥/æ„ŸæŸ“ã€ç›¸é—œ **********/
      function isAntibioticRelatedObservation(obs) {
        if (!obs || !obs.code) return false;

        const text = (obs.code.text || "").toLowerCase();
        const codings = obs.code.coding || [];

        const codeStrings = codings
          .map(
            (c) =>
              `${c.system || ""}|${c.code || ""}|${c.display || ""}`.toLowerCase()
          )
          .join(" ");

        // 1) å…ˆç”¨é—œéµå­—ç²—ç•¥ç¯©é¸ (é™¢å…§å¯æ”¹æˆå¯¦éš›æª¢é©—åç¨±/ä»£ç¢¼)
        const keywords = [
          "culture",
          "bacteria",
          "bacteri",
          "organism",
          "antibiotic",
          "susceptibil",
          "resistan",
          "mrsa",
          "vre",
          "esbl",
          "carbapenem",
          "acinetobacter",
          "pseudomonas",
          "klebsiella",
        ];

        const haystack = (text + " " + codeStrings).toLowerCase();
        const hitKeyword = keywords.some((k) => haystack.includes(k));

        // åªè¦åƒæ˜¯ã€Œå¾®ç”Ÿç‰©/æŠ—è—¥ã€å°±å…ˆæ”¶ï¼Œå¾ŒçºŒå†ç”¨èŒç¨®ä¸‹æ‹‰åšç¬¬äºŒå±¤éæ¿¾
        if (!hitKeyword) return false;

        return true;
      }

      /********** åˆ¤æ–·ï¼šObservation æ˜¯å¦ç¬¦åˆä¸‹æ‹‰é¸åˆ°çš„èŒç¨® **********/
      function isObservationMatchBacteria(obs, organismText, bacteriaOption) {
        if (!bacteriaOption || bacteriaOption.id === "ALL") return true;
        const hay = (organismText || "").toLowerCase();
        if (!hay) return false;
        return bacteriaOption.keywords.some((k) => hay.includes(k));
      }

      /********** ç•« FHIR é€£ç·šè³‡è¨Š **********/
      function renderMeta(client) {
        const div = document.getElementById("meta-content");
        const st = client.state || {};
        const url = st.serverUrl || "(æœªçŸ¥)";
        const token = st.tokenResponse || {};
        const patientId = st.patientId || (client.patient && client.patient.id);

        div.innerHTML = `
          <div>
            <span class="meta-label">FHIR Serverï¼š</span>
            <span>${url}</span>
          </div>
          <div>
            <span class="meta-label">Access Tokenï¼š</span>
            <span>${token.access_token ? "å·²å–å¾—" : "å°šæœªå–å¾— / ä¸éœ€ token"}</span>
          </div>
          <div>
            <span class="meta-label">Patient Id (context)ï¼š</span>
            <span>${patientId || "(ç„¡ç—…äºº context æˆ–ç‚º system/user app)"}</span>
          </div>
          <div>
            <span class="meta-label">Scopeï¼š</span>
            <span>${st.tokenResponse?.scope || "(æœªçŸ¥)"}</span>
          </div>
        `;
      }

      /********** å¾ FHIR å»ºç«‹å‚³æ’­éˆæ‰€éœ€çš„è³‡æ–™çµæ§‹ **********/
      async function buildTransmissionData(client, bacteriaOption, manualPatientId) {
        const state = client.state || {};
        const contextPatientId =
          state.patientId || (client.patient && client.patient.id) || null;

        const targetPatientId = manualPatientId || contextPatientId || null;

        let bundle = null;
        let isSinglePatientMode = false;

        if (targetPatientId) {
          // ğŸ”¹ æŒ‡å®šç—…äººæ¨¡å¼ï¼šsubject=Patient/{id}
          isSinglePatientMode = true;
          const encodedId = encodeURIComponent(targetPatientId);
          const query = `Observation?subject=Patient/${encodedId}&category=laboratory&_count=20&_include=Observation:subject&_include=Observation:encounter&_include:iterate=Encounter:location`;
          bundle = await client.request(query, { flat: false });
          logDebug(
            bundle,
            `Observation Bundleï¼ˆæŒ‡å®šç—…äºº ${targetPatientId}ï¼Œ_count=20, laboratoryï¼‰`
          );
        } else {
          // ğŸ”¹ å¤šç—…äººæ¨¡å¼
          bundle = await client.request(
            "Observation?category=laboratory&_count=20&_include=Observation:subject&_include=Observation:encounter",
            { flat: false }
          );
          logDebug(
            bundle,
            "Observation Bundleï¼ˆå¤šç—…äººæ¨¡å¼ï¼Œ_count=20, laboratoryï¼‰"
          );
        }

        const entries = bundle.entry || [];
        const patientsById = {}; // id -> Patient resource
        const encountersById = {}; // id -> Encounter resource
        const observations = [];

        // æ”¶é›† Observation / Patient / Encounter / Location
        for (const e of entries) {
          const res = e.resource;
          if (!res || !res.resourceType) continue;
          if (res.resourceType === "Observation") {
            observations.push(res);
          } else if (res.resourceType === "Patient") {
            patientsById[res.id] = res;
          } else if (res.resourceType === "Encounter") {
            encountersById[res.id] = res;
          }
        }

        // å–®ç—…äººæ¨¡å¼è£œæŠ“ Patientï¼ˆå¦‚æœæ²’æœ‰è¢« _include åˆ°ï¼‰
        if (isSinglePatientMode && targetPatientId && !patientsById[targetPatientId]) {
          try {
            const p = await client.request(`Patient/${encodeURIComponent(targetPatientId)}`);
            patientsById[p.id] = p;
            logDebug(p, "è£œæŠ“ Patientï¼ˆå–®ä¸€ç—…äººæ¨¡å¼ï¼‰");
          } catch (err) {
            logDebug(err, "è£œæŠ“ Patient å¤±æ•—");
          }
        }

        const cases = []; // æ¯ä¸€å€‹ case å°æ‡‰ä¸€å€‹ã€ŒæŠ—è—¥èŒäº‹ä»¶ã€

        for (const obs of observations) {
          if (!isAntibioticRelatedObservation(obs)) {
            continue;
          }

          const subjRef = obs.subject && obs.subject.reference;
          if (!subjRef || !subjRef.startsWith("Patient/")) continue;
          const patientId = subjRef.split("/")[1];

          if (isSinglePatientMode && targetPatientId && patientId !== targetPatientId) {
            continue;
          }

          const patientRes = patientsById[patientId];

          const encRef = obs.encounter && obs.encounter.reference;
          let enc = null;
          let wardName = "";
          if (encRef && encRef.startsWith("Encounter/")) {
            const encId = encRef.split("/")[1];
            enc = encountersById[encId];
          }
          if (enc) {
            wardName =
              (enc.location &&
                enc.location[0] &&
                enc.location[0].location &&
                enc.location[0].location.display) ||
              (enc.serviceProvider && enc.serviceProvider.display) ||
              "";
          }

          const code = obs.code || {};
          const coding0 = (code.coding && code.coding[0]) || {};
          const organismTextSource =
            (code.text || "") +
            " " +
            (coding0.display || "") +
            " " +
            (coding0.code || "");
          const organism =
            code.text || coding0.display || coding0.code || "æœªæ¨™è¨»èŒå";

          if (!isObservationMatchBacteria(obs, organismTextSource, bacteriaOption)) {
            continue;
          }

          const effective =
            obs.effectiveDateTime ||
            (obs.effectivePeriod && obs.effectivePeriod.start) ||
            obs.issued ||
            "";
          const dateKey = effective ? String(effective).slice(0, 10) : "æœªçŸ¥æ—¥æœŸ";
          const locKey = wardName || "æœªçŸ¥åœ°é»";

          cases.push({
            obsId: obs.id,
            patientId,
            patientRes,
            encounter: enc,
            wardName: locKey,
            organism,
            dateKey,
          });
        }

        logDebug(
          {
            caseCount: cases.length,
            patientCount: Object.keys(patientsById).length,
            bacteria: bacteriaOption.label,
            mode: isSinglePatientMode ? `å–®ä¸€ç—…äººï¼š${targetPatientId || ""}` : "å¤šç—…äºº",
          },
          "åˆæ­¥ç—…ä¾‹ Case æ•¸çµ±è¨ˆï¼ˆä¾èŒæ ªéæ¿¾å¾Œï¼‰"
        );

        return { cases, patientsById, isSinglePatientMode, targetPatientId };
      }

      /********** å¾ cases çµ„å‡ºã€Œç—…äººç¯€é» + æ¥è§¸é»ç¯€é» + é‚Šã€ **********/
      function buildGraphElementsFromCases(cases, patientsById) {
        const patientNodeMap = {}; // patientId -> node
        const contactNodeMap = {}; // contactKey -> node
        const pcEdges = [];
        const ppEdgeSet = new Set();
        const contactToPatients = {};

        for (const c of cases) {
          const pId = c.patientId;

          // ç—…äººç¯€é»
          if (!patientNodeMap[pId]) {
            const p = patientsById[pId];
            let displayName = "";

            if (p && p.name && p.name[0]) {
              const n = p.name[0];
              const full =
                n.text ||
                `${n.family || ""}${(n.given || []).join("")}`.trim();
              displayName = full || "";
            }

            const masked =
              maskName(displayName) || shortId(pId) || "æœªçŸ¥ç—…äºº";
            patientNodeMap[pId] = {
              id: "p-" + pId,
              label: masked,
            };
          }

          // æ¥è§¸é»ï¼šç—…æˆ¿ + èŒå + æ—¥æœŸ
          const contactKey = `${c.wardName}|${c.organism}|${c.dateKey}`;
          if (!contactNodeMap[contactKey]) {
            const nodeId =
              "c-" +
              btoa(unescape(encodeURIComponent(contactKey))).replace(/=/g, "");
            const label = `${c.wardName}\n${c.organism}\n${c.dateKey}`;
            contactNodeMap[contactKey] = {
              id: nodeId,
              label,
            };
          }

          pcEdges.push({
            patientId: pId,
            contactKey,
          });

          if (!contactToPatients[contactKey]) {
            contactToPatients[contactKey] = new Set();
          }
          contactToPatients[contactKey].add(pId);
        }

        // P-P é‚Šï¼šå…±äº«æ¥è§¸é»çš„ç—…äººå…©å…©ç›¸é€£
        const ppEdges = [];
        for (const [contactKey, set] of Object.entries(contactToPatients)) {
          const arr = Array.from(set);
          for (let i = 0; i < arr.length; i++) {
            for (let j = i + 1; j < arr.length; j++) {
              const a = arr[i];
              const b = arr[j];
              if (a === b) continue;
              const pid1 = a < b ? a : b;
              const pid2 = a < b ? b : a;
              const key = pid1 + "|" + pid2;
              if (ppEdgeSet.has(key)) continue;
              ppEdgeSet.add(key);
              ppEdges.push({
                from: "p-" + pid1,
                to: "p-" + pid2,
              });
            }
          }
        }

        const elements = [];

        // ç—…äººç¯€é»
        Object.values(patientNodeMap).forEach((p) => {
          elements.push({
            data: {
              id: p.id,
              label: p.label,
              type: "patient",
            },
          });
        });

        // æ¥è§¸é»ç¯€é»
        Object.values(contactNodeMap).forEach((c) => {
          elements.push({
            data: {
              id: c.id,
              label: c.label,
              type: "contact",
            },
          });
        });

        // P-C é‚Š
        pcEdges.forEach((e, idx) => {
          const pNode = patientNodeMap[e.patientId];
          const cNode = contactNodeMap[e.contactKey];
          if (!pNode || !cNode) return;
          elements.push({
            data: {
              id: "pc-" + idx,
              source: pNode.id,
              target: cNode.id,
              type: "pc",
            },
          });
        });

        // P-P é‚Š
        ppEdges.forEach((e, idx) => {
          elements.push({
            data: {
              id: "pp-" + idx,
              source: e.from,
              target: e.to,
              type: "pp",
            },
          });
        });

        return {
          elements,
          patientCount: Object.keys(patientNodeMap).length,
          contactCount: Object.keys(contactNodeMap).length,
          pcCount: pcEdges.length,
          ppCount: ppEdges.length,
        };
      }

      /********** ç”¨ Cytoscape ç•«åœ– **********/
      function renderGraph(elements, statsText) {
        const statsDiv = document.getElementById("graph-stats");
        statsDiv.textContent = statsText;

        const cy = cytoscape({
          container: document.getElementById("cy"),
          elements: elements,
          style: [
            {
              selector: "node[type = 'patient']",
              style: {
                "background-color": "#f28b82",
                "border-color": "#042433",
                "border-width": 2,
                label: "data(label)",
                "text-valign": "center",
                "text-halign": "center",
                "text-wrap": "wrap",
                "font-size": 10,
                shape: "ellipse",
                width: 40,
                height: 40,
              },
            },
            {
              selector: "node[type = 'contact']",
              style: {
                "background-color": "#aecbfa",
                "border-color": "#042433",
                "border-width": 1,
                label: "data(label)",
                "text-valign": "center",
                "text-halign": "center",
                "text-wrap": "wrap",
                "font-size": 9,
                shape: "round-rectangle",
                padding: "4px",
              },
            },
            {
              selector: "edge[type = 'pc']",
              style: {
                "line-style": "dotted",
                "line-color": "#7a7a7a",
                "target-arrow-shape": "none",
                width: 1,
              },
            },
            {
              selector: "edge[type = 'pp']",
              style: {
                "line-style": "solid",
                "line-color": "#7a7a7a",
                "target-arrow-shape": "triangle",
                "target-arrow-color": "#7a7a7a",
                "curve-style": "straight",
                width: 2,
              },
            },
            {
              selector: ":selected",
              style: {
                "border-width": 3,
                "border-color": "#ffab00",
                "line-color": "#ffab00",
                "target-arrow-color": "#ffab00",
              },
            },
            {
              selector: ".dim",
              style: {
                opacity: 0.2,
              },
            },
          ],
          layout: {
            name: "cose",
            animate: false,
          },
        });

        // é»ç—…äººç¯€é»æ™‚ highlight ç›¸é—œ
        cy.on("tap", "node[type = 'patient']", (evt) => {
          const node = evt.target;
          cy.elements().removeClass("dim");
          const neighborhood = node.closedNeighborhood();
          cy.elements().difference(neighborhood).addClass("dim");
        });

        // é»ç©ºç™½é‚„åŸ
        cy.on("tap", (evt) => {
          if (evt.target === cy) {
            cy.elements().removeClass("dim");
          }
        });
      }

      /********** åˆå§‹åŒ–æ•´å€‹ App **********/
      FHIR.oauth2
        .ready()
        .then(async (client) => {
          logDebug(client.state, "SMART client.state");
          renderMeta(client);

          const reloadBtn = document.getElementById("btn-reload-graph");
          const clearBtn = document.getElementById("btn-clear-debug");
          const selOrganism = document.getElementById("sel-organism");
          const txtPatientId = document.getElementById("txt-patient-id");

          async function reloadGraph() {
            const opt = getSelectedBacteriaOption();
            const manualPid = (txtPatientId.value || "").trim();
            const pidDesc = manualPid ? `ï¼ŒæŒ‡å®šç—…äººï¼š${manualPid}` : "";

            reloadBtn.disabled = true;
            document.getElementById("graph-stats").textContent =
              `å¾ FHIR è®€å–è³‡æ–™ä¸¦é‡å»ºå‚³æ’­éˆä¸­...ï¼ˆæœ€å¤š 20 ç­† Observationï¼ŒèŒç¨®ï¼š${opt.label}${pidDesc}ï¼‰`;

            try {
              const { cases, patientsById } = await buildTransmissionData(
                client,
                opt,
                manualPid || null
              );
              if (!cases.length) {
                renderGraph(
                  [],
                  `æŸ¥ç„¡ç¬¦åˆæ¢ä»¶çš„æŠ—è—¥èŒ Observationï¼ˆèŒç¨®ï¼š${opt.label}${pidDesc}ï¼‰ï¼Œç„¡æ³•å»ºç«‹å‚³æ’­éˆã€‚`
                );
                reloadBtn.disabled = false;
                return;
              }

              const {
                elements,
                patientCount,
                contactCount,
                pcCount,
                ppCount,
              } = buildGraphElementsFromCases(cases, patientsById);

              const statsText = `ç¯€é»ï¼šç—…äºº ${patientCount} äººã€æ¥è§¸é» ${contactCount} å€‹ï¼›é‚Šï¼šç—…äºº-æ¥è§¸é» ${pcCount} æ¢ã€ç—…äºº-ç—…äºº ${ppCount} æ¢ã€‚ï¼ˆèŒç¨®ï¼š${opt.label}ï¼ŒåŸºæ–¼æœ€å¤š 20 ç­† Observation${pidDesc}ï¼‰`;
              renderGraph(elements, statsText);
            } catch (err) {
              console.error(err);
              logDebug(err, "å»ºç«‹å‚³æ’­éˆå¤±æ•—");
              document.getElementById("graph-stats").innerHTML =
                '<span class="error">ç„¡æ³•å¾ FHIR å»ºç«‹å‚³æ’­éˆï¼Œè«‹æŸ¥çœ‹ä¸‹æ–¹ Debug è¨Šæ¯ã€‚</span>';
              renderGraph([], "å»ºç«‹å‚³æ’­éˆå¤±æ•—ã€‚");
            } finally {
              reloadBtn.disabled = false;
            }
          }

          // åˆæ¬¡è¼‰å…¥
          await reloadGraph();

          // ç¶å®šäº‹ä»¶
          reloadBtn.addEventListener("click", reloadGraph);
          clearBtn.addEventListener("click", () => {
            document.getElementById("debug-log").textContent =
              "// å·²æ¸…é™¤è¨Šæ¯ï¼Œå¯é‡æ–°æ“ä½œã€‚";
          });
          selOrganism.addEventListener("change", reloadGraph);

          // åœ¨ PatientID è¼¸å…¥æ¡†æŒ‰ Enter ä¹Ÿé‡è¼‰
          txtPatientId.addEventListener("keydown", (e) => {
            if (e.key === "Enter") {
              reloadGraph();
            }
          });
        })
        .catch((err) => {
          console.error("SMART åˆå§‹åŒ–å¤±æ•—", err);
          logDebug(err, "SMART åˆå§‹åŒ–å¤±æ•—");
          document.getElementById("meta-content").innerHTML =
            '<span class="error">SMART åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèª launch.html è¨­å®šèˆ‡æ²™ç›’ç’°å¢ƒã€‚</span>';
          document.getElementById("graph-stats").textContent =
            "ç„¡æ³•è¼‰å…¥ FHIR è³‡æ–™ã€‚";
        });
    </script>
  </body>
</html>
